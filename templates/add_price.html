{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="page-title">
        <i class="fas fa-dollar-sign"></i>
        <h1>Agregar Precio</h1>
    </div>
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-info">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    {% if error_message %}
    <div class="error-message">{{ error_message }}</div>
    {% endif %}
    <form method="POST">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.product.label }}
            {{ form.product(class="form-control", onchange="updateProductDetails(this.value)") }}
        </div>
        <div class="form-group">
            <label for="brand">Marca</label>
            <select id="brand" name="brand" class="form-control" onchange="updatePresentations(this.value)" required>
                <option value="">Seleccione una marca</option>
            </select>
        </div>
        <div class="form-group">
            {{ form.store.label }}
            {{ form.store(class="form-control") }}
        </div>
        <div class="form-group">
            <label for="presentation">Presentación</label>
            <select id="presentation" name="presentation" class="form-control" required>
                <option value="">Seleccione una presentación</option>
            </select>
        </div>
        <div class="form-group">
            {{ form.price.label }}
            <input type="number" id="price" name="price" class="form-control" step="0.01" required>
        </div>
        <div class="form-group">
            {{ form.date.label }}
            <input type="date" id="date" name="date" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary">Guardar</button>
    </form>
</div>

<script>
let productData = null;

document.addEventListener('DOMContentLoaded', function() {
    const productSelect = document.getElementById('product');
    if (productSelect.value) {
        updateProductDetails(productSelect.value);
    }
    
    // Establecer la fecha actual por defecto
    const dateInput = document.getElementById('date');
    if (!dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
});

function updateProductDetails(productName) {
    if (!productName) return;

    fetch(`/get_product_details/${encodeURIComponent(productName)}`)
        .then(response => response.json())
        .then(data => {
            productData = data;
            
            // Actualizar el dropdown de marcas
            const brandSelect = document.getElementById('brand');
            brandSelect.innerHTML = '<option value="">Seleccione una marca</option>';
            data.brands.forEach(brand => {
                const option = new Option(brand, brand);
                brandSelect.add(option);
            });
            
            // Si solo hay una marca, seleccionarla y actualizar presentaciones
            if (data.brands.length === 1) {
                brandSelect.value = data.brands[0];
                updatePresentations(data.brands[0]);
            } else {
                // Limpiar presentaciones si hay múltiples marcas
                const presentationSelect = document.getElementById('presentation');
                presentationSelect.innerHTML = '<option value="">Seleccione una presentación</option>';
            }
        })
        .catch(error => {
            console.error('Error al obtener detalles del producto:', error);
        });
}

function updatePresentations(brand) {
    if (!productData || !brand) return;
    
    const presentations = productData.presentationsByBrand[brand] || [];
    const presentationSelect = document.getElementById('presentation');
    presentationSelect.innerHTML = '<option value="">Seleccione una presentación</option>';
    
    presentations.forEach(presentation => {
        const option = new Option(presentation, presentation);
        presentationSelect.add(option);
    });
    
    // Si solo hay una presentación, seleccionarla automáticamente
    if (presentations.length === 1) {
        presentationSelect.value = presentations[0];
    }
}
</script>
{% endblock %}