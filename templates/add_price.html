{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="page-title">
        <i class="fas fa-dollar-sign"></i>
        <h1>Agregar Precio</h1>
    </div>
    {% if error_message %}
    <div class="error-message">{{ error_message }}</div>
    {% endif %}
    <form method="POST">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.product.label }}
            {{ form.product(class="form-control", onchange="updateProductDetails(this.value)") }}
        </div>
        <div class="form-group">
            {{ form.brand.label }}
            {{ form.brand(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.store.label }}
            {{ form.store(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.presentation.label }}
            {{ form.presentation(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.price.label }}
            {{ form.price(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.date.label }}
            {{ form.date(class="form-control") }}
        </div>
        {{ form.submit(class="btn btn-primary") }}
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productSelect = document.getElementById('product');
    if (productSelect.value) {
        updateProductDetails(productSelect.value);
    }
    
    // Establecer la fecha actual por defecto
    const dateInput = document.getElementById('date');
    if (!dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
});

function updateProductDetails(productId) {
    if (!productId) return;

    fetch(`/get_product_details/${productId}`)
        .then(response => response.json())
        .then(data => {
            // Actualizar el dropdown de marcas
            const brandSelect = document.getElementById('brand');
            brandSelect.innerHTML = '';
            data.brands.forEach(brand => {
                const option = new Option(brand, brand);
                brandSelect.add(option);
            });

            // Actualizar el dropdown de presentaciones
            const presentationInput = document.getElementById('presentation');
            presentationInput.value = '';
            if (data.presentations.length > 0) {
                presentationInput.value = data.presentations[0];
            }
            
            // Si solo hay una marca, seleccionarla automÃ¡ticamente
            if (data.brands.length === 1) {
                brandSelect.value = data.brands[0];
            }
        })
        .catch(error => {
            console.error('Error al obtener detalles del producto:', error);
        });
}
</script>
{% endblock %}