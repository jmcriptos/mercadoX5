{% extends "base.html" %}

{% block title %}Generar Gráfico{% endblock %}

{% block content %}
<div class="container">
    <div class="page-title">
        <i class="fas fa-chart-line"></i>
        <h1>Generar Gráfico</h1>
    </div>

    <form id="graphForm" class="card" onsubmit="return handleSubmit(event)">
        <div class="form-group">
            <label for="start_date">Fecha de inicio:</label>
            <input type="date" id="start_date" name="start_date" required>
        </div>

        <div class="form-group">
            <label for="end_date">Fecha de fin:</label>
            <input type="date" id="end_date" name="end_date" required value="{{ today }}">
        </div>

        <div class="form-group">
            <label for="product_name">Nombre del producto:</label>
            <select id="product_name" name="product_name" required>
                <option value="">Seleccione un producto</option>
                {% for product in products %}
                <option value="{{ product.name }}">{{ product.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="brand">Marca:</label>
            <select id="brand" name="brand" disabled>
                <option value="all">Todas</option>
            </select>
        </div>

        <div class="form-group">
            <label for="store">Tienda:</label>
            <select id="store" name="store">
                <option value="all">Todas</option>
                {% for store in stores %}
                <option value="{{ store.id }}">{{ store.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="presentation">Presentación:</label>
            <select id="presentation" name="presentation" required disabled>
            </select>
        </div>

        <button type="submit" class="btn-primary">Generar Gráfico</button>
    </form>

    <div id="graphContainer" class="card" style="display: none;">
        <div id="loadingMessage">Cargando gráfico...</div>
        <div id="graphDiv"></div>
        <button id="downloadButton" class="btn-secondary">Descargar como imagen</button>
    </div>
</div>

<div id="errorContainer" style="display: none;" class="alert alert-danger">
    <p id="errorMessage"></p>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
// Configuración inicial de fechas
function initializeDates() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('end_date').value = today;
    
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    document.getElementById('start_date').value = thirtyDaysAgo.toISOString().split('T')[0];
}

// Mostrar mensajes de error
function showError(message) {
    const errorContainer = document.getElementById('errorContainer');
    const errorMessage = document.getElementById('errorMessage');
    errorMessage.textContent = message;
    errorContainer.style.display = 'block';
    setTimeout(() => {
        errorContainer.style.display = 'none';
    }, 5000);
}

// Manejar la selección de productos y cargar marcas y presentaciones dinámicamente
async function handleProductChange(productName) {
    const brandSelect = document.getElementById('brand');
    const presentationSelect = document.getElementById('presentation');

    // Resetear selects si no hay producto seleccionado
    if (!productName) {
        brandSelect.innerHTML = '<option value="all">Todas</option>';
        presentationSelect.innerHTML = '';
        brandSelect.disabled = true;
        presentationSelect.disabled = true;
        return;
    }

    try {
        // Deshabilitar los selectores durante la carga
        brandSelect.disabled = true;
        presentationSelect.disabled = true;

        // Obtener los detalles del producto desde el backend
        const response = await fetch(`/get_product_details/${encodeURIComponent(productName)}`);
        if (!response.ok) throw new Error('Error en la petición');

        const data = await response.json();
        if (data.success) {
            // Llenar el selector de marcas
            brandSelect.innerHTML = '<option value="all">Todas</option>';
            data.brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandSelect.appendChild(option);
            });
            brandSelect.disabled = false;

            // Llenar el selector de presentaciones
            presentationSelect.innerHTML = '';
            data.presentations.forEach(pres => {
                const option = document.createElement('option');
                option.value = pres;
                option.textContent = pres;
                presentationSelect.appendChild(option);
            });
            if (data.presentations.length > 0) {
                presentationSelect.value = data.presentations[0];
            }
            presentationSelect.disabled = false;
        } else {
            throw new Error(data.error || 'Error al obtener datos');
        }
    } catch (error) {
        showError('Error al cargar los detalles del producto: ' + error.message);
        brandSelect.innerHTML = '<option value="all">Todas</option>';
        presentationSelect.innerHTML = '';
        brandSelect.disabled = true;
        presentationSelect.disabled = true;
    }
}

// Manejar el envío del formulario
async function handleSubmit(event) {
    event.preventDefault();
    
    const loadingMessage = document.getElementById('loadingMessage');
    const graphContainer = document.getElementById('graphContainer');
    const graphDiv = document.getElementById('graphDiv');

    // Mostrar estado de carga
    loadingMessage.style.display = 'block';
    graphDiv.style.display = 'none';
    graphContainer.style.display = 'block';

    try {
        const form = event.target;
        const formData = new FormData(form);

        const response = await fetch('/graph', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        if (!response.ok || data.error) throw new Error(data.error);

        // Ocultar mensaje de carga y mostrar gráfico
        loadingMessage.style.display = 'none';
        graphDiv.style.display = 'block';

        const traces = data.data.map((item, index) => ({
            x: item.dates,
            y: item.prices,
            mode: 'lines+markers',
            name: item.label
        }));

        const layout = {
            title: data.title,
            xaxis: { title: 'Fecha', tickangle: -45 },
            yaxis: { title: 'Precio', tickformat: '.2f' },
            hovermode: 'x unified'
        };

        Plotly.newPlot('graphDiv', traces, layout);
    } catch (error) {
        loadingMessage.style.display = 'none';
        showError('Error al generar el gráfico: ' + error.message);
    }

    return false;
}

// Inicializar eventos y fechas cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    initializeDates();

    const productSelect = document.getElementById('product_name');
    if (productSelect) {
        productSelect.addEventListener('change', (e) => handleProductChange(e.target.value));
    }

    const downloadButton = document.getElementById('downloadButton');
    if (downloadButton) {
        downloadButton.addEventListener('click', function() {
            Plotly.downloadImage('graphDiv', {
                format: 'png',
                filename: 'grafico',
                width: 1200,
                height: 800
            });
        });
    }
});
</script>
{% endblock %}

