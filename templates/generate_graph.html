{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="page-title">
        <i class="fas fa-chart-line"></i>
        <h1>Generar Gr치fico</h1>
    </div>

    <form id="graphForm" method="POST" action="/graph" class="card">
        <div class="form-group">
            <label for="start_date">Fecha de inicio:</label>
            <input type="date" id="start_date" name="start_date" required>
        </div>

        <div class="form-group">
            <label for="end_date">Fecha de fin:</label>
            <input type="date" id="end_date" name="end_date" required>
        </div>

        <div class="form-group">
            <label for="product_name">Nombre del producto:</label>
            <select id="product_name" name="product_name" required>
                {% for product in products %}
                <option value="{{ product.name }}">{{ product.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="brand">Marca:</label>
            <select id="brand" name="brand">
                <option value="all">Todas</option>
                {% for brand in brands %}
                <option value="{{ brand }}">{{ brand }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="store">Tienda:</label>
            <select id="store" name="store">
                <option value="all">Todas</option>
                {% for store in stores %}
                <option value="{{ store.id }}">{{ store.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="presentation">Presentaci칩n:</label>
            <select id="presentation" name="presentation" required>
                {% for presentation in presentations %}
                <option value="{{ presentation[0] }}">{{ presentation[0] }}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit">Generar Gr치fico</button>
    </form>

    <div id="graphContainer" class="card" style="display: none;">
        <div id="graphDiv"></div>
        <button id="downloadButton">Descargar como imagen</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    document.getElementById('graphForm').addEventListener('submit', function (e) {
        e.preventDefault();

        fetch('/graph', {
            method: 'POST',
            body: new FormData(e.target)
        })
            .then(response => response.json())
            .then(data => {
                data.data.forEach(item => {
                    item.dates = item.dates.map(date => date.split(" ")[0]);
                });

                let traces = data.data.map((item, index) => {
                    const colors = [
                        '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
                        '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'
                    ];
                    return {
                        x: item.dates,
                        y: item.prices,
                        mode: 'lines+markers',
                        name: item.label,
                        hovertemplate: '%{y:$.2f}<extra></extra>',
                        marker: {
                            size: 10,
                            color: colors[index % colors.length]
                        },
                        line: {
                            color: colors[index % colors.length]
                        }
                    };
                });

                const layout = {
                    title: data.title,
                    xaxis: {
                        title: data.xAxisTitle,
                        tickformat: '%Y-%m-%d'
                    },
                    yaxis: {
                        title: data.yAxisTitle,
                        tickformat: '$.2f'
                    },
                    legend: {
                        font: {
                            size: 12
                        }
                    },
                    margin: {
                        t: 60,
                        b: 60,
                        l: 60,
                        r: 60
                    },
                    hovermode: 'closest',
                    hoverlabel: {
                        namelength: -1
                    }
                };

                document.getElementById('graphContainer').style.display = 'block';

                Plotly.newPlot('graphDiv', traces, layout, { responsive: true });
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Hubo un error al generar el gr치fico.');
            });
    });

    document.getElementById('downloadButton').addEventListener('click', function () {
        html2canvas(document.getElementById('graphDiv')).then(function (canvas) {
            const link = document.createElement('a');
            link.download = 'grafico.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    });
</script>
{% endblock %}