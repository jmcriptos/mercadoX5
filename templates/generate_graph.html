{% extends "base.html" %}

{% block title %}Generar Gráfico{% endblock %}

{% block content %}
<!-- Mantener el contenido existente del form -->
{{ super() }}
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  initializeDates();
  setupDownloadButton();
});

function initializeDates() {
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("end_date").value = today;
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  document.getElementById("start_date").value = thirtyDaysAgo.toISOString().split("T")[0];
}

function setupDownloadButton() {
  const downloadButton = document.getElementById("downloadButton");
  if (downloadButton) {
    downloadButton.addEventListener("click", function() {
      Plotly.downloadImage("graphDiv", {
        format: "png",
        filename: "grafico",
        width: 1200,
        height: 800
      });
    });
  }
}

function showError(message) {
  console.error("Error:", message);
  const errorContainer = document.getElementById("errorContainer");
  const errorMessage = document.getElementById("errorMessage");
  errorMessage.textContent = message;
  errorContainer.style.display = "block";
  setTimeout(() => {
    errorContainer.style.display = "none";
  }, 5000);
}

async function handleSubmit(event) {
  event.preventDefault();
  const form = document.getElementById("graphForm");
  const graphContainer = document.getElementById("graphContainer");
  const loadingMessage = document.getElementById("loadingMessage");
  const graphDiv = document.getElementById("graphDiv");

  try {
    const formData = new FormData(form);
    if (formData.get("start_date") > formData.get("end_date")) {
      showError("La fecha de inicio no puede ser mayor a la fecha de fin.");
      return false;
    }

    graphContainer.style.display = "block";
    loadingMessage.style.display = "block";
    graphDiv.style.display = "none";

    const response = await fetch(form.action, {
      method: "POST",
      body: formData
    });
    
    const data = await response.json();
    console.log("Datos recibidos:", data);

    if (!response.ok || data.error) {
      throw new Error(data.error || "Error en la respuesta de /graph");
    }

    loadingMessage.style.display = "none";
    graphDiv.style.display = "block";

    const colors = [
      '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
      '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'
    ];

    const traces = data.data.map((item, index) => ({
      x: item.dates,
      y: item.prices,
      mode: 'lines+markers',
      name: item.label,
      line: { color: colors[index % colors.length] },
      marker: { size: 10, color: colors[index % colors.length] },
      customdata: item.prices.map(price => ({
        store: item.label,
        price: price
      })),
      hovertemplate: '%{customdata.store}: Bs. %{customdata.price:.2f}<extra></extra>'
    }));

    const layout = {
      title: data.title,
      xaxis: {
        title: 'Fecha',
        tickangle: -45,
        automargin: true
      },
      yaxis: {
        title: 'Precio',
        tickformat: '.2f'
      },
      showlegend: true,
      legend: {
        x: 0,
        y: -0.5,
        orientation: 'h',
        yanchor: 'top'
      },
      hovermode: 'closest',
      hoverlabel: {
        bgcolor: 'white',
        font: { size: 12, color: 'black' },
        bordercolor: 'gray'
      },
      margin: {
        l: 80,
        r: 50,
        t: 100,
        b: 200
      }
    };

    const config = {
      responsive: true,
      displayModeBar: true,
      displaylogo: false
    };

    Plotly.newPlot("graphDiv", traces, layout, config).then(function(gd) {
      gd.on('plotly_hover', function(eventData) {
        if (!eventData.points || eventData.points.length === 0) return;

        const date = eventData.points[0].x;
        const pointsAtDate = [];

        // Recolectar todos los puntos para la fecha seleccionada
        gd.data.forEach((trace, traceIndex) => {
          const dateIndex = trace.x.indexOf(date);
          if (dateIndex !== -1) {
            pointsAtDate.push({
              store: trace.name,
              price: trace.y[dateIndex]
            });
          }
        });

        // Ordenar por precio (menor a mayor)
        pointsAtDate.sort((a, b) => a.price - b.price);

        // Construir tooltip
        const tooltip = document.getElementById("customTooltip");
        const dateObj = new Date(date);
        const dateStr = dateObj.toLocaleDateString('es-VE', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });

        let content = `<div style="font-weight: bold; margin-bottom: 5px;">${dateStr}</div>`;
        pointsAtDate.forEach(point => {
          content += `<div>${point.store}: Bs. ${point.price.toFixed(2)}</div>`;
        });

        tooltip.innerHTML = content;
        tooltip.style.display = 'block';

        // Posicionar tooltip
        let x = eventData.event.clientX + 10;
        let y = eventData.event.clientY + 10;

        const rect = tooltip.getBoundingClientRect();
        if (x + rect.width > window.innerWidth) {
          x = eventData.event.clientX - rect.width - 10;
        }
        if (y + rect.height > window.innerHeight) {
          y = eventData.event.clientY - rect.height - 10;
        }

        tooltip.style.left = x + 'px';
        tooltip.style.top = y + 'px';
      });

      gd.on('plotly_unhover', function() {
        document.getElementById("customTooltip").style.display = 'none';
      });
    });

  } catch (error) {
    loadingMessage.style.display = 'none';
    showError("Error al generar el gráfico: " + error.message);
  }

  return false;
}
</script>
{% endblock %}
