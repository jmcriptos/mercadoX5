{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    // Función para actualizar las opciones de marca y presentación
    function updateProductOptions(productName) {
        if (!productName) {
            // Si no hay producto seleccionado, limpiar las opciones
            document.getElementById('brand').innerHTML = '<option value="all">Todas</option>';
            document.getElementById('presentation').innerHTML = '<option value="">Seleccione una presentación</option>';
            return;
        }

        fetch(`/get_product_details/${encodeURIComponent(productName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Actualizar presentaciones
                    const presentationSelect = document.getElementById('presentation');
                    presentationSelect.innerHTML = '<option value="">Seleccione una presentación</option>';
                    data.presentations.forEach(presentation => {
                        presentationSelect.add(new Option(presentation, presentation));
                    });

                    // Actualizar marcas
                    const brandSelect = document.getElementById('brand');
                    brandSelect.innerHTML = '<option value="all">Todas</option>';
                    data.brands.forEach(brand => {
                        brandSelect.add(new Option(brand, brand));
                    });
                } else {
                    console.error('Error:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    // Agregar event listener para el cambio de producto
    document.getElementById('product_name').addEventListener('change', function() {
        updateProductOptions(this.value);
    });

    // Event listener para el formulario
    document.getElementById('graphForm').addEventListener('submit', function (e) {
        e.preventDefault();

        fetch('/graph', {
            method: 'POST',
            body: new FormData(e.target)
        })
        .then(response => response.json())
        .then(data => {
            data.data.forEach(item => {
                item.dates = item.dates.map(date => date.split(" ")[0]);
            });

            // Ordenar los datos por el último precio
            data.data.sort((a, b) => {
                const lastPriceA = a.prices[a.prices.length - 1];
                const lastPriceB = b.prices[b.prices.length - 1];
                return lastPriceB - lastPriceA;
            });

            let traces = data.data.map((item, index) => {
                const colors = [
                    '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
                    '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'
                ];
                return {
                    x: item.dates,
                    y: item.prices,
                    mode: 'lines+markers',
                    name: item.label,
                    hovertemplate: 
                        '%{text}<br>' +
                        'Fecha: %{x}<br>' +
                        'Precio: ANG %{y:.2f}<extra></extra>',
                    text: new Array(item.dates.length).fill(item.label),
                    marker: {
                        size: 10,
                        color: colors[index % colors.length]
                    },
                    line: {
                        color: colors[index % colors.length]
                    }
                };
            });

            const layout = {
                title: {
                    text: data.title,
                    font: { size: 20 }
                },
                xaxis: {
                    title: 'Mes y Año',
                    tickangle: -45,
                    tickformat: '%b %d, %Y'
                },
                yaxis: {
                    title: 'Precio (ANG)',
                    tickformat: '.2f',
                    tickprefix: 'ANG '
                },
                showlegend: true,
                legend: {
                    x: 0,
                    y: -0.5,
                    orientation: 'h',
                    yanchor: 'top',
                    font: { size: 12 }
                },
                margin: {
                    l: 80,
                    r: 50,
                    t: 100,
                    b: 200
                },
                hovermode: 'x unified'
            };

            document.getElementById('graphContainer').style.display = 'block';

            Plotly.newPlot('graphDiv', traces, layout, { 
                responsive: true,
                displayModeBar: true,
                displaylogo: false 
            });
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Hubo un error al generar el gráfico.');
        });
    });

    document.getElementById('downloadButton').addEventListener('click', function () {
        html2canvas(document.getElementById('graphDiv')).then(function (canvas) {
            const link = document.createElement('a');
            link.download = 'grafico.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    });
</script>
{% endblock %}