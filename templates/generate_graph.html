{% extends "base.html" %}

{% block title %}Generar Gráfico{% endblock %}

{% block content %}
<style>
.graph-container {
    width: 100%;
    margin: 20px auto;
    padding: 20px;
}

#graphDiv {
    width: 100%;
    height: 700px;
    margin: 20px 0;
}

.button-container {
    text-align: center;
    margin: 20px 0;
}

#customTooltip {
    position: absolute;
    display: none;
    background: white;
    border: 1px solid #ccc;
    padding: 8px;
    border-radius: 4px;
    z-index: 1000;
    pointer-events: none;
    font-size: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    min-width: 200px;
}

.form-group {
    margin-bottom: 15px;
}

.card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#loadingMessage {
    text-align: center;
    padding: 20px;
    font-size: 16px;
    color: #666;
}

.alert {
    padding: 15px;
    margin-bottom: 20px;
    border: 1px solid transparent;
    border-radius: 4px;
}

.alert-danger {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
}

.btn-primary {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
}

select, input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-top: 4px;
}

label {
    font-weight: bold;
    color: #333;
}
</style>

<div class="container">
    <div class="page-title">
        <h1>Generar Gráfico</h1>
    </div>

    <form id="graphForm" class="card" method="POST" action="/graph">
        <div class="form-group">
            <label for="start_date">Fecha de inicio:</label>
            <input type="date" id="start_date" name="start_date" required>
        </div>

        <div class="form-group">
            <label for="end_date">Fecha de fin:</label>
            <input type="date" id="end_date" name="end_date" required>
        </div>

        <div class="form-group">
            <label for="product_name">Nombre del producto:</label>
            <select id="product_name" name="product_name" required>
                {% for product in products %}
                <option value="{{ product.name }}">{{ product.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="brand">Marca:</label>
            <select id="brand" name="brand">
                <option value="all">Todas</option>
                {% for b in all_brands %}
                <option value="{{ b }}">{{ b }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="store">Tienda:</label>
            <select id="store" name="store">
                <option value="all">Todas</option>
                {% for s in stores %}
                <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="presentation">Presentación:</label>
            <select id="presentation" name="presentation" required>
                {% for p in all_presentations %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="btn-primary">Generar Gráfico</button>
    </form>

    <div class="graph-container">
        <div id="loadingMessage" style="display:none;">Cargando gráfico...</div>
        <div id="graphDiv"></div>
        <div class="button-container">
            <button id="downloadButton" class="btn-secondary">Descargar como imagen</button>
        </div>
    </div>
</div>

<div id="customTooltip"></div>
<div id="errorContainer" style="display:none;" class="alert alert-danger">
    <p id="errorMessage"></p>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeDates();
    setupForm();
    setupDownloadButton();
});

function initializeDates() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('end_date').value = today.toISOString().split('T')[0];
    document.getElementById('start_date').value = thirtyDaysAgo.toISOString().split('T')[0];
}

function setupForm() {
    const form = document.getElementById('graphForm');
    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const formData = new FormData(this);
        if (formData.get('start_date') > formData.get('end_date')) {
            showError('La fecha de inicio no puede ser mayor a la fecha de fin.');
            return;
        }

        const loadingMessage = document.getElementById('loadingMessage');
        const graphDiv = document.getElementById('graphDiv');

        try {
            loadingMessage.style.display = 'block';
            graphDiv.style.display = 'none';

            const response = await fetch('/graph', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            console.log('Datos recibidos:', data);

            if (!response.ok) {
                throw new Error(data.error || 'Error en la respuesta del servidor');
            }

            loadingMessage.style.display = 'none';
            graphDiv.style.display = 'block';

            createPlot(data);
            document.getElementById('downloadButton').style.display = 'block';

        } catch (error) {
            console.error('Error:', error);
            showError(error.message);
            loadingMessage.style.display = 'none';
        }
    });
}

function setupDownloadButton() {
    document.getElementById('downloadButton').addEventListener('click', function() {
        Plotly.downloadImage('graphDiv', {
            format: 'png',
            filename: 'grafico',
            width: 1200,
            height: 800,
            scale: 2
        });
    });
}

function createPlot(data) {
    if (!data.data || !Array.isArray(data.data) || data.data.length === 0) {
        showError('No hay datos para graficar');
        return;
    }

    const colors = [
        '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
        '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'
    ];

    const traces = data.data.map((item, index) => ({
        x: item.dates,
        y: item.prices,
        mode: 'lines+markers',
        name: item.label,
        line: { color: colors[index % colors.length] },
        marker: { 
            size: 10, 
            color: colors[index % colors.length],
            opacity: 0.8,
            line: {
                color: 'black',
                width: 2
            }
        },
        hoverinfo: 'none'
    }));

    const layout = {
        title: {
            text: data.title,
            font: { size: 24 }
        },
        xaxis: {
            title: 'Fecha',
            tickangle: -45,
            automargin: true
        },
        yaxis: {
            title: 'Precio',
            tickformat: '.2f',
            automargin: true
        },
        showlegend: true,
        legend: {
            x: 0,
            y: -0.3,
            orientation: 'h',
            yanchor: 'top',
            xanchor: 'left'
        },
        hovermode: 'closest',
        hoverdistance: 50,
        margin: {
            l: 100,
            r: 50,
            t: 100,
            b: 150
        },
        autosize: true,
        height: 600
    };

    const config = {
        responsive: true,
        displayModeBar: true,
        displaylogo: false
    };

    Plotly.newPlot('graphDiv', traces, layout, config).then(function(gd) {
        gd.on('plotly_hover', function(eventData) {
            const points = eventData.points;
            if (!points || points.length === 0) return;

            const date = points[0].x;
            const pointsAtDate = [];

            // Recolectar todos los puntos para la fecha
            gd.data.forEach(trace => {
                const dateIndex = trace.x.indexOf(date);
                if (dateIndex !== -1) {
                    pointsAtDate.push({
                        store: trace.name,
                        price: trace.y[dateIndex]
                    });
                }
            });

            if (pointsAtDate.length === 0) return;

            // Ordenar por precio (menor a mayor)
            pointsAtDate.sort((a, b) => a.price - b.price);

            // Formatear fecha
            const dateObj = new Date(date);
            const dateStr = dateObj.toLocaleDateString('es-VE', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Construir tooltip
            let content = `<div style="font-weight:bold; padding-bottom:5px; margin-bottom:5px; border-bottom:1px solid #ccc;">
                            ${dateStr}
                          </div>`;
            
            pointsAtDate.forEach(point => {
                content += `<div style="padding:2px 0;">
                            ${point.store}: Bs. ${point.price.toFixed(2)}
                          </div>`;
            });

            // Mostrar y posicionar tooltip
            const tooltip = document.getElementById('customTooltip');
            tooltip.innerHTML = content;
            tooltip.style.cssText = `
                display: block;
                position: absolute;
                background: white;
                border: 1px solid #ccc;
                border-radius: 4px;
                padding: 8px;
                font-size: 12px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                z-index: 1000;
                pointer-events: none;
                min-width: 200px;
            `;

            // Calcular posición
            let x = eventData.event.pageX + 10;
            let y = eventData.event.pageY + 10;

            const rect = tooltip.getBoundingClientRect();
            if (x + rect.width > window.innerWidth) {
                x = eventData.event.pageX - rect.width - 10;
            }
            if (y + rect.height > window.innerHeight) {
                y = eventData.event.pageY - rect.height - 10;
            }

            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        });

        gd.on('plotly_unhover', function() {
            document.getElementById('customTooltip').style.display = 'none';
        });

        setTimeout(() => {
            Plotly.Plots.resize(gd);
        }, 100);
    });
}

function showError(message) {
    const errorContainer = document.getElementById('errorContainer');
    const errorMessage = document.getElementById('errorMessage');
    errorMessage.textContent = message;
    errorContainer.style.display = 'block';
    setTimeout(() => {
        errorContainer.style.display = 'none';
    }, 5000);
}
</script>
{% endblock %}
