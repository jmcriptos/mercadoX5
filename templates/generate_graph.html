<!DOCTYPE html>
<html>

<head>
    <title>Generar Gr치fico</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
    <div class="container">
        <img src="../static/LOGO JOMAR.png" alt="MercadoX5" class="logo" />
    </div>
    <h1>MercadoX5</h1>
    <h1>Generar Gr치fico</h1>
    <form id="graphForm" method="POST" action="/graph">
        <div>
            <label for="start_date">Fecha de inicio:</label>
            <input type="date" id="start_date" name="start_date" required>
        </div>

        <div>
            <label for="end_date">Fecha de fin:</label>
            <input type="date" id="end_date" name="end_date" required>
        </div>

        <div>
            <label for="product_name">Nombre del producto:</label>
            <select id="product_name" name="product_name" required>
                {% for product in products %}
                <option value="{{ product.name }}">{{ product.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="brand">Marca:</label>
            <select id="brand" name="brand">
                <option value="all">Todas</option>
                {% for brand in brands %}
                <option value="{{ brand }}">{{ brand }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="store">Tienda:</label>
            <select id="store" name="store">
                <option value="all">Todas</option>
                {% for store in stores %}
                <option value="{{ store.id }}">{{ store.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="presentation">Presentaci칩n:</label>
            <select id="presentation" name="presentation" required>
                {% for presentation in presentations %}
                <option value="{{ presentation[0] }}">{{ presentation[0] }}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit">Generar Gr치fico</button>
    </form>

    <div id="graphDiv"></div>


    <div class="button-container">
        <a href="/"><button>Volver</button></a>
    </div>

    <script>
        document.getElementById('graphForm').addEventListener('submit', function (e) {
            e.preventDefault();

            fetch('/graph', {
                method: 'POST',
                body: new FormData(e.target)
            })
                .then(response => response.json())
                .then(data => {
                    data.data.forEach(item => {
                        item.dates = item.dates.map(date => {
                            return date.split(" ")[0];
                        });
                    });

                    let traces = data.data.map(item => {
                        return {
                            x: item.dates,
                            y: item.prices,
                            mode: 'lines+markers',
                            name: item.label
                        };
                    });

                    const layout = {
                        title: data.title,
                        xaxis: {
                            title: data.xAxisTitle,
                            tickformat: '%Y-%m-%d'
                        },
                        yaxis: {
                            title: data.yAxisTitle
                        },
                        hoverlabel: {
                            namelength: -1
                        }
                    };

                    Plotly.newPlot('graphDiv', traces, layout);
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('There was an error generating the graph.');
                });
        });
    </script>
</body>

</html>
