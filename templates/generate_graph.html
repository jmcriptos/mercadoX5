<!DOCTYPE html>
<html>
<head>
    <title>Generar Gr치fico</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>MercadoX5</h1>
    <h1>Generar Gr치fico</h1>
    <form id="graphForm" method="POST" action="/graph">
        <label for="start_date">Fecha de inicio:</label>
        <input type="date" id="start_date" name="start_date" required>

        <label for="end_date">Fecha de fin:</label>
        <input type="date" id="end_date" name="end_date" required>

        <label for="product_name">Nombre del producto:</label>
        <select id="product_name" name="product_name" required>
            {% for product in products %}
                <option value="{{ product.name }}">{{ product.name }}</option>
            {% endfor %}
        </select>

        <label for="filter_type">Filtrar por:</label>
<select id="filter_type" name="filter_type">
    <option value="brand">Marca</option>
    <option value="store">Tienda</option>
</select>

        <label for="store">Tienda:</label>
        <select id="store" name="store">
        <option value="all">Todas</option>
            {% for store in stores %}
                <option value="{{ store.id }}">{{ store.name }}</option>
            {% endfor %}
        </select>

        <label for="presentation">Presentaci칩n:</label>
        <select id="presentation" name="presentation" required>
            {% for presentation in presentations %}
                <option value="{{ presentation[0] }}">{{ presentation[0] }}</option>
            {% endfor %}
        </select>

        <button type="submit">Generar Gr치fico</button>
    </form>

    <div id="graphDiv"></div>

    <script>
        document.getElementById('graphForm').addEventListener('submit', function(e) {
    e.preventDefault();
    fetch('/graph', {
        method: 'POST',
        body: new FormData(e.target)
    })
    .then(response => response.json())
    .then(data => {
        const traces = [];
        const filterType = document.getElementById('filter_type').value;

        if (filterType === "brand") {
            data.data.forEach(item => {
                traces.push({
                    x: item.dates,
                    y: item.prices,
                    mode: 'lines+markers',
                    name: item.brand,
                    text: item.dates.map((date, index) => `Marca: ${item.brand}<br>Tienda: ${item.stores[index]}<br>Fecha: ${date}<br>Precio: ${item.prices[index]}`),
                    hoverinfo: "text",
                    line: { shape: 'spline' }
                });
            });
        } else if (filterType === "store") {
            const storeMap = {}; // Para agrupar por tienda
            data.data.forEach(item => {
                item.dates.forEach((date, index) => {
                    const storeName = item.stores[index];
                    if (!storeMap[storeName]) {
                        storeMap[storeName] = {dates: [], prices: []};
                    }
                    storeMap[storeName].dates.push(date);
                    storeMap[storeName].prices.push(item.prices[index]);
                });
            });

            for (const [storeName, storeData] of Object.entries(storeMap)) {
                traces.push({
                    x: storeData.dates,
                    y: storeData.prices,
                    mode: 'lines+markers',
                    name: storeName,
                    text: storeData.dates.map((date, index) => `Tienda: ${storeName}<br>Fecha: ${date}<br>Precio: ${storeData.prices[index]}`),
                    hoverinfo: "text",
                    line: { shape: 'spline' }
                });
            }
        }

        const layout = {
            title: data.title,
            xaxis: { title: data.xAxisTitle },
            yaxis: { title: data.yAxisTitle },
            showlegend: true
        };

        Plotly.newPlot('graphDiv', traces, layout);
    });
});

        </script>

    <div style="margin-top: 20px;">
        <div class="button-container">
            <a href="/" style="margin-top: 10px;"><button>Volver</button></a>
        </div>
    </div>

</body>
</html>
