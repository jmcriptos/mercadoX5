{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="page-title">
        <i class="fas fa-chart-line"></i>
        <h1>Generar Gráfico</h1>
    </div>

    <form id="graphForm" method="POST" action="/graph" class="card">
        <div class="form-group">
            <label for="start_date">Fecha de inicio:</label>
            <input type="date" id="start_date" name="start_date" required>
        </div>

        <div class="form-group">
            <label for="end_date">Fecha de fin:</label>
            <input type="date" id="end_date" name="end_date" required value="{{ today }}">
        </div>

        <div class="form-group">
            <label for="product_name">Nombre del producto:</label>
            <select id="product_name" name="product_name" required>
                <option value="">Seleccione un producto</option>
                {% for product in products %}
                <option value="{{ product.name }}">{{ product.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="brand">Marca:</label>
            <select id="brand" name="brand">
                <option value="all">Todas</option>
            </select>
        </div>

        <div class="form-group">
            <label for="store">Tienda:</label>
            <select id="store" name="store">
                <option value="all">Todas</option>
                {% for store in stores %}
                <option value="{{ store.id }}">{{ store.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="presentation">Presentación:</label>
            <select id="presentation" name="presentation" required>
                <option value="">Seleccione una presentación</option>
            </select>
        </div>

        <button type="submit">Generar Gráfico</button>
    </form>

    <div id="graphContainer" class="card" style="display: none;">
        <div id="graphDiv"></div>
        <button id="downloadButton">Descargar como imagen</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Librerías externas para gráficos y captura de pantalla -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
    // Se ejecuta cuando todo el DOM está cargado
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Documento y script listos. Preparando inicialización...');

        // Asignamos fechas por defecto
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('end_date').value = today;
        
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        document.getElementById('start_date').value = thirtyDaysAgo.toISOString().split('T')[0];
        
        // Inicializamos los selects de marca y presentación
        resetSelectors();
    });

    // Evento change del select de producto
    document.getElementById('product_name').addEventListener('change', function() {
        const productName = this.value;
        const brandSelect = document.getElementById('brand');
        const presentationSelect = document.getElementById('presentation');

        // Mensaje de depuración
        console.log('¡Evento change de product_name disparado! Producto:', productName);

        // Reseteamos marcas y presentaciones
        resetSelectors();

        if (productName) {
            // Deshabilitamos mientras cargamos
            brandSelect.disabled = true;
            presentationSelect.disabled = true;

            // Hacemos la petición fetch para obtener marcas y presentaciones
            fetch(`/get_product_details/${encodeURIComponent(productName)}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Respuesta de /get_product_details:', data);
                    if (data.success) {
                        // Rellenamos marcas
                        brandSelect.innerHTML = '<option value="all">Todas</option>';
                        if (data.brands && data.brands.length > 0) {
                            data.brands.forEach(brand => {
                                if (brand) {
                                    const option = document.createElement('option');
                                    option.value = brand;
                                    option.textContent = brand;
                                    brandSelect.appendChild(option);
                                }
                            });
                        }

                        // Rellenamos presentaciones
                        presentationSelect.innerHTML = '<option value="">Seleccione una presentación</option>';
                        if (data.presentations && data.presentations.length > 0) {
                            data.presentations.forEach(pres => {
                                if (pres) {
                                    const option = document.createElement('option');
                                    option.value = pres;
                                    option.textContent = pres;
                                    presentationSelect.appendChild(option);
                                }
                            });
                        }
                    } else {
                        console.error('Error en la respuesta:', data.error);
                        alert('Error al cargar los detalles del producto');
                    }
                })
                .catch(error => {
                    console.error('Error en fetch:', error);
                    alert('Error al cargar los detalles del producto');
                })
                .finally(() => {
                    // Rehabilitamos
                    brandSelect.disabled = false;
                    presentationSelect.disabled = false;
                });
        }
    });

    // Función para resetear los select de brand y presentation
    function resetSelectors() {
        const brandSelect = document.getElementById('brand');
        const presentationSelect = document.getElementById('presentation');
        
        brandSelect.innerHTML = '<option value="all">Todas</option>';
        presentationSelect.innerHTML = '<option value="">Seleccione una presentación</option>';
        
        brandSelect.disabled = false;
        presentationSelect.disabled = false;
    }

    // Manejo de envío del formulario para generar el gráfico
    document.getElementById('graphForm').addEventListener('submit', function(e) {
        e.preventDefault();

        fetch('/graph', {
            method: 'POST',
            body: new FormData(e.target)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Datos de /graph recibidos:', data);

            data.data.forEach(item => {
                // Ajustamos fechas al formato YYYY-MM-DD
                item.dates = item.dates.map(date => date.split(' ')[0]);
            });

            // Ordenamos los datos por el último precio (descendente)
            data.data.sort((a, b) => {
                const lastPriceA = a.prices[a.prices.length - 1];
                const lastPriceB = b.prices[b.prices.length - 1];
                return lastPriceB - lastPriceA;
            });

            // Creamos las trazas para Plotly
            const traces = data.data.map((item, index) => {
                const colors = [
                    '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
                    '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'
                ];
                return {
                    x: item.dates,
                    y: item.prices,
                    mode: 'lines+markers',
                    name: item.label,
                    hovertemplate:
                        '%{text}<br>' +
                        'Fecha: %{x}<br>' +
                        'Precio: ANG %{y:.2f}<extra></extra>',
                    text: new Array(item.dates.length).fill(item.label),
                    marker: {
                        size: 8,
                        color: colors[index % colors.length]
                    },
                    line: {
                        color: colors[index % colors.length]
                    }
                };
            });

            // Configuración del layout de la gráfica
            const layout = {
                title: { text: data.title, font: { size: 20 } },
                xaxis: {
                    title: 'Mes y Año',
                    tickangle: -45,
                    tickformat: '%b %d, %Y'
                },
                yaxis: {
                    title: 'Precio (ANG)',
                    tickformat: '.2f',
                    tickprefix: 'ANG '
                },
                showlegend: true,
                legend: {
                    x: 0,
                    y: -0.5,
                    orientation: 'h',
                    yanchor: 'top',
                    font: { size: 12 }
                },
                margin: { l: 80, r: 50, t: 100, b: 200 },
                hovermode: 'x unified',
                hoverdistance: 100,
                spikedistance: 1000
            };

            // Mostramos el contenedor del gráfico
            document.getElementById('graphContainer').style.display = 'block';

            // Dibujamos la gráfica
            Plotly.newPlot('graphDiv', traces, layout, {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['lasso2d', 'select2d']
            });
        })
        .catch(error => {
            console.error('Error en /graph:', error);
            alert('Hubo un error al generar el gráfico.');
        });
    });

    // Botón para descargar la gráfica como imagen
    document.getElementById('downloadButton').addEventListener('click', function() {
        html2canvas(document.getElementById('graphDiv')).then(function(canvas) {
            const link = document.createElement('a');
            link.download = 'grafico.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    });
</script>
{% endblock %}
