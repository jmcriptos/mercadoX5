{% extends "base.html" %}

{% block title %}Generar Gráfico{% endblock %}

{% block content %}
<div class="container">
    <div class="page-title">
        <i class="fas fa-chart-line"></i>
        <h1>Generar Gráfico</h1>
    </div>

    <!-- Se establece method="POST" y action="/graph" para que la petición se realice vía AJAX -->
    <form id="graphForm" class="card" method="POST" action="/graph" onsubmit="return handleSubmit(event)">
        <!-- Fechas -->
        <div class="form-group">
            <label for="start_date">Fecha de inicio:</label>
            <input type="date" id="start_date" name="start_date" required>
        </div>
        <div class="form-group">
            <label for="end_date">Fecha de fin:</label>
            <input type="date" id="end_date" name="end_date" required>
        </div>

        <!-- Producto -->
        <div class="form-group">
            <label for="product_name">Nombre del producto:</label>
            <select id="product_name" name="product_name">
                <option value="all">Todos</option>
                {% for product in products %}
                <option value="{{ product.name }}">{{ product.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Marca -->
        <div class="form-group">
            <label for="brand">Marca:</label>
            <select id="brand" name="brand">
                <option value="all">Todas</option>
                {% for b in all_brands %}
                <option value="{{ b }}">{{ b }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Tienda -->
        <div class="form-group">
            <label for="store">Tienda:</label>
            <select id="store" name="store">
                <option value="all">Todas</option>
                {% for s in stores %}
                <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Presentación -->
        <div class="form-group">
            <label for="presentation">Presentación:</label>
            <select id="presentation" name="presentation" required>
                <option value="all">Todas</option>
                {% for p in all_presentations %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Botón de envío -->
        <button type="submit" class="btn-primary">Generar Gráfico</button>
    </form>

    <div id="graphContainer" class="card" style="display: none; margin-top:20px;">
        <div id="loadingMessage">Cargando gráfico...</div>
        <!-- Se define un tamaño para que Plotly disponga de un área para dibujar -->
        <div id="graphDiv" style="width: 100%; height: 600px;"></div>
        <button id="downloadButton" class="btn-secondary">Descargar como imagen</button>
    </div>
</div>

<div id="errorContainer" style="display: none;" class="alert alert-danger">
    <p id="errorMessage"></p>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    console.log("Página generate_graph cargada.");
    initializeDates();

    const downloadButton = document.getElementById("downloadButton");
    if (downloadButton) {
        downloadButton.addEventListener("click", function() {
            Plotly.downloadImage("graphDiv", {
                format: "png",
                filename: "grafico",
                width: 1200,
                height: 800
            }).then(() => {
                console.log("Imagen descargada.");
            }).catch((err) => {
                console.error("Error al descargar la imagen:", err);
            });
        });
    }
});

function initializeDates() {
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("end_date").value = today;

    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    document.getElementById("start_date").value = thirtyDaysAgo.toISOString().split("T")[0];
}

function showError(message) {
    console.error("Error:", message);
    const errorContainer = document.getElementById("errorContainer");
    const errorMessage = document.getElementById("errorMessage");
    errorMessage.textContent = message;
    errorContainer.style.display = "block";
    setTimeout(() => {
        errorContainer.style.display = "none";
    }, 5000);
}

async function handleSubmit(event) {
    event.preventDefault();  // Evita el envío tradicional del formulario
    console.log("handleSubmit disparado!");

    const form = document.getElementById("graphForm");
    const graphContainer = document.getElementById("graphContainer");
    const loadingMessage = document.getElementById("loadingMessage");
    const graphDiv = document.getElementById("graphDiv");

    // Mostrar el contenedor y mensaje de carga
    graphContainer.style.display = "block";
    loadingMessage.style.display = "block";
    graphDiv.style.display = "none";

    const formData = new FormData(form);

    // Validación simple de fechas
    const startDate = formData.get("start_date");
    const endDate = formData.get("end_date");
    if (startDate > endDate) {
        showError("La fecha de inicio no puede ser mayor a la fecha de fin.");
        return false;
    }

    try {
        // Realiza la petición POST a /graph
        const response = await fetch(form.action, {
            method: "POST",
            body: formData
        });
        const data = await response.json();
        console.log("Datos recibidos:", data);

        if (!response.ok || data.error) {
            throw new Error(data.error || "Error en la respuesta de /graph");
        }

        // Ocultar el mensaje de carga y mostrar el contenedor del gráfico
        loadingMessage.style.display = "none";
        graphDiv.style.display = "block";

        // Construir las trazas para Plotly
        const traces = data.data.map(item => ({
            x: item.dates,
            y: item.prices,
            mode: "lines+markers",
            name: item.label
        }));

        const layout = {
            title: data.title,
            xaxis: { title: "Fecha", tickangle: -45 },
            yaxis: { title: "Precio", tickformat: ".2f" },
            hovermode: "x unified"
        };

        console.log("Dibujando gráfico con:", traces, layout);
        Plotly.newPlot("graphDiv", traces, layout)
          .then(function() {
              console.log("Gráfico generado correctamente.");
          })
          .catch(function(error) {
              console.error("Error al dibujar el gráfico:", error);
              showError("Error al dibujar el gráfico: " + error.message);
          });

    } catch (error) {
        loadingMessage.style.display = "none";
        showError("Error al generar el gráfico: " + error.message);
    }
    return false; // Para asegurarnos de que no se realice el envío tradicional
}
</script>
{% endblock %}