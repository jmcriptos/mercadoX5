{% extends "base.html" %}

{% block title %}Generar Gráfico{% endblock %}

{% block content %}
<div class="container">
    <div class="page-title">
        <i class="fas fa-chart-line"></i>
        <h1>Generar Gráfico</h1>
    </div>

    <form id="graphForm" class="card" onsubmit="return handleSubmit(event)">
        <div class="form-group">
            <label for="start_date">Fecha de inicio:</label>
            <input type="date" id="start_date" name="start_date" required>
        </div>

        <div class="form-group">
            <label for="end_date">Fecha de fin:</label>
            <input type="date" id="end_date" name="end_date" required value="{{ today }}">
        </div>

        <div class="form-group">
            <label for="product_name">Nombre del producto:</label>
            <select id="product_name" name="product_name" required>
                <option value="">Seleccione un producto</option>
                {% for product in products %}
                <option value="{{ product.name }}">{{ product.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="brand">Marca:</label>
            <select id="brand" name="brand">
                <option value="all">Todas</option>
                {% for b in all_brands %}
                    <option value="{{ b }}">{{ b }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="store">Tienda:</label>
            <select id="store" name="store">
                <option value="all">Todas</option>
                {% for store in stores %}
                <option value="{{ store.id }}">{{ store.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="presentation">Presentación:</label>
            <select id="presentation" name="presentation" required>
                <option value="all">Todas</option>
                {% for pres in all_presentations %}
                    <option value="{{ pres }}">{{ pres }}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="btn-primary">Generar Gráfico</button>
    </form>

    <div id="graphContainer" class="card" style="display: none;">
        <div id="loadingMessage">Cargando gráfico...</div>
        <div id="graphDiv"></div>
        <button id="downloadButton" class="btn-secondary">Descargar como imagen</button>
    </div>
</div>

<div id="errorContainer" style="display: none;" class="alert alert-danger">
    <p id="errorMessage"></p>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Página cargada, inicializando...');
    
    // Configurar fechas iniciales
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('end_date').value = today;
    
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    document.getElementById('start_date').value = thirtyDaysAgo.toISOString().split('T')[0];

    // Manejar cambios en el producto
    document.getElementById('product_name').addEventListener('change', function() {
        const productName = this.value;
        console.log('Producto seleccionado:', productName);
        if (!productName) return;

        fetch(`/get_product_details/${encodeURIComponent(productName)}`)
            .then(response => response.json())
            .then(data => {
                console.log('Detalles del producto recibidos:', data);
                if (data.success) {
                    updateSelects(data.brands, data.presentations);
                }
            })
            .catch(error => {
                console.error('Error al obtener detalles:', error);
                showError('Error al cargar detalles del producto');
            });
    });
});

function showError(message) {
    const errorContainer = document.getElementById('errorContainer');
    const errorMessage = document.getElementById('errorMessage');
    errorMessage.textContent = message;
    errorContainer.style.display = 'block';
}

function updateSelects(brands, presentations) {
    console.log('Actualizando selectores con:', { brands, presentations });
    
    // Actualizar marcas
    const brandSelect = document.getElementById('brand');
    brandSelect.innerHTML = '<option value="all">Todas</option>';
    brands.forEach(brand => {
        const option = document.createElement('option');
        option.value = brand;
        option.textContent = brand;
        brandSelect.appendChild(option);
    });

    // Actualizar presentaciones
    const presentationSelect = document.getElementById('presentation');
    presentationSelect.innerHTML = '<option value="all">Todas</option>';
    presentations.forEach(pres => {
        const option = document.createElement('option');
        option.value = pres;
        option.textContent = pres;
        presentationSelect.appendChild(option);
    });
}

async function handleSubmit(event) {
    event.preventDefault();
    console.log('Formulario enviado');
    
    const loadingMessage = document.getElementById('loadingMessage');
    const graphContainer = document.getElementById('graphContainer');
    const graphDiv = document.getElementById('graphDiv');
    
    try {
        // Mostrar estado de carga
        loadingMessage.style.display = 'block';
        graphDiv.style.display = 'none';
        graphContainer.style.display = 'block';
        
        const form = event.target;
        const formData = new FormData(form);
        
        console.log('Enviando datos:', Object.fromEntries(formData));

        const response = await fetch('/graph', {
            method: 'POST',
            body: formData
        });
        
        console.log('Respuesta recibida, status:', response.status);
        const data = await response.json();
        console.log('Datos recibidos:', data);

        if (!data || data.error) {
            throw new Error(data.error || 'Error al recibir datos');
        }

        // Ocultar mensaje de carga y mostrar gráfico
        loadingMessage.style.display = 'none';
        graphDiv.style.display = 'block';

        // Procesar datos
        data.data.forEach(item => {
            item.dates = item.dates.map(date => date.split(' ')[0]);
        });

        // Crear trazas
        const colors = [
            '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
            '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'
        ];

        const traces = data.data.map((item, index) => ({
            x: item.dates,
            y: item.prices,
            mode: 'lines+markers',
            name: item.label,
            hovertemplate:
                '%{text}<br>' +
                'Fecha: %{x}<br>' +
                'Precio: ANG %{y:.2f}<extra></extra>',
            text: new Array(item.dates.length).fill(item.label),
            marker: {
                size: 8,
                color: colors[index % colors.length]
            },
            line: {
                color: colors[index % colors.length]
            }
        }));

        const layout = {
            title: {
                text: data.title,
                font: { size: 20 }
            },
            xaxis: {
                title: 'Fecha',
                tickangle: -45
            },
            yaxis: {
                title: 'Precio (ANG)',
                tickformat: '.2f',
                tickprefix: 'ANG '
            },
            showlegend: true,
            legend: {
                x: 0,
                y: -0.5,
                orientation: 'h',
                yanchor: 'top'
            },
            margin: {
                l: 80,
                r: 50,
                t: 100,
                b: 200
            },
            hovermode: 'x unified'
        };

        console.log('Generando gráfico con:', { traces, layout });
        
        Plotly.newPlot('graphDiv', traces, layout, {
            responsive: true,
            displayModeBar: true,
            displaylogo: false,
            modeBarButtonsToRemove: ['lasso2d', 'select2d']
        });
    } catch (error) {
        console.error('Error:', error);
        loadingMessage.style.display = 'none';
        showError('Error al generar el gráfico: ' + error.message);
    }
    
    return false;
}

// Configurar botón de descarga
document.getElementById('downloadButton').addEventListener('click', function() {
    Plotly.downloadImage('graphDiv', {
        format: 'png',
        filename: 'grafico',
        width: 1200,
        height: 800
    });
});
</script>
{% endblock %}

