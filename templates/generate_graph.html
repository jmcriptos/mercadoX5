<!DOCTYPE html>
<html>
<head>
    <title>Generar Gráfico</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>MercadoX5</h1>
    <h1>Generar Gráfico</h1>
    <form id="graphForm" method="POST" action="/graph">
        <label for="start_date">Fecha de inicio:</label>
        <input type="date" id="start_date" name="start_date" required>

        <label for="end_date">Fecha de fin:</label>
        <input type="date" id="end_date" name="end_date" required>

        <label for="product_name">Nombre del producto:</label>
        <select id="product_name" name="product_name" required>
            {% for product in products %}
                <option value="{{ product.name }}">{{ product.name }}</option>
            {% endfor %}
        </select>

        <label for="brand">Marca:</label>
    <select id="brand" name="brand">
        <option value="all">Todas</option>
        {% for brand in brands %}
        <option value="{{ brand }}">{{ brand }}</option>
        {% endfor %}
    </select>

        <label for="store">Tienda:</label>
        <select id="store" name="store">
        <option value="all">Todas</option>
            {% for store in stores %}
                <option value="{{ store.id }}">{{ store.name }}</option>
            {% endfor %}
        </select>

        <label for="presentation">Presentación:</label>
        <select id="presentation" name="presentation" required>
            {% for presentation in presentations %}
                <option value="{{ presentation[0] }}">{{ presentation[0] }}</option>
            {% endfor %}
        </select>

        <button type="submit">Generar Gráfico</button>
    </form>

    <div id="graphDiv"></div>

    <script>
        function buildConsistentDataSeries(dataSeries) {
            // Obtener un conjunto único de todas las fechas
            let allDates = [];
            dataSeries.forEach(series => {
                allDates = allDates.concat(series.dates);
            });
            allDates = [...new Set(allDates)].sort();  // Eliminar duplicados y ordenar

            // Asegurarse de que cada serie de datos tenga un valor para cada fecha
            dataSeries.forEach(series => {
                let newPrices = [];
                allDates.forEach(date => {
                    let index = series.dates.indexOf(date);
                    if (index !== -1) {
                        newPrices.push(series.prices[index]);
                    } else {
                        newPrices.push(null);  // O cualquier valor por defecto que prefieras
                    }
                });
                series.dates = allDates;
                series.prices = newPrices;
            });

            return dataSeries;
        }

        document.getElementById('graphForm').addEventListener('submit', function(e) {
            e.preventDefault();

            fetch('/graph', {
                method: 'POST',
                body: new FormData(e.target)
            })
            .then(response => response.json())
            .then(data => {
                // Usar la función para homogeneizar las fechas
                data.data = buildConsistentDataSeries(data.data);

                let traces = data.data.map(item => {
                    return {
                        x: item.dates,
                        y: item.prices,
                        mode: 'lines+markers',
                        name: item.label,
                        connectgaps: true  // Conecta las líneas a través de puntos de datos faltantes
                    };
                });

                const layout = {
                    title: data.title,
                    xaxis: {
                        title: data.xAxisTitle,
                        type: 'date'
                    },
                    yaxis: {
                        title: data.yAxisTitle
                    }
                };

                Plotly.newPlot('graphDiv', traces, layout);
            })
            .catch(err => {
                console.error('Error:', err);
                alert('There was an error generating the graph.');
            });
        });

    </script>

    <div style="margin-top: 20px;">
        <div class="button-container">
            <a href="/" style="margin-top: 10px;"><button>Volver</button></a>
        </div>
    </div>

</body>
</html>
