{% extends "base.html" %}

{% block title %}Generar Gráfico{% endblock %}

{% block content %}
<div class="container">
  <div class="page-title">
    <i class="fas fa-chart-line"></i>
    <h1>Generar Gráfico</h1>
  </div>

  {% if not current_user.is_authenticated %}
  <div class="alert alert-warning" role="alert">
    <i class="fas fa-exclamation-triangle"></i>
    Debe iniciar sesión para generar gráficos.
    <a href="{{ url_for('login', next=request.path) }}" class="alert-link">Iniciar sesión</a>
  </div>
  {% endif %}

  <!-- Formulario -->
  <form id="graphForm" class="card" method="POST" action="/generate_graph">
    <div class="form-row">
      <div class="form-group">
        <label for="start_date">Fecha de inicio:</label>
        <input type="date" id="start_date" name="start_date" required>
      </div>
      <div class="form-group">
        <label for="end_date">Fecha de fin:</label>
        <input type="date" id="end_date" name="end_date" required>
      </div>
    </div>

    <div class="form-row">
      <!-- Producto con Awesomplete -->
      <div class="form-group">
        <label for="product_search">Nombre del producto:</label>
        <div class="search-container">
          <input 
            type="text" 
            id="product_search" 
            class="search-input awesomplete" 
            placeholder="Buscar producto..." 
            autocomplete="off"
          >
          <!-- Valor seleccionado -->
          <input type="hidden" id="product_name" name="product_name" required>
        </div>
      </div>

      <!-- Marcas: selección múltiple, se actualizará según el producto -->
      <div class="form-group">
        <label for="brand">Marcas:</label>
        <select id="brand" name="brand[]" multiple>
          <option value="all">Todas</option>
          {% for b in all_brands %}
          <option value="{{ b }}">{{ b }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="form-row">
      <!-- Tiendas: selección múltiple -->
      <div class="form-group">
        <label for="store">Tiendas:</label>
        <select id="store" name="store[]" multiple>
          <option value="all">Todas</option>
          {% for s in stores %}
          <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Presentaciones: se actualizará según las marcas seleccionadas -->
      <div class="form-group">
        <label for="presentation">Presentación:</label>
        <select id="presentation" name="presentation" required>
          <option value="all">Todas</option>
          {% for p in all_presentations %}
          <option value="{{ p }}">{{ p }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <button type="submit" class="btn-primary">Generar Gráfico</button>
  </form>

  <!-- Contenedor para el gráfico y descarga -->
  <div class="graph-container card">
    <div id="loadingMessage" style="display:none;">Cargando gráfico...</div>
    <div id="graphDiv"></div>
    <div class="button-container">
      <button id="downloadButton" class="btn-secondary" style="display:none;">Descargar como imagen</button>
    </div>
  </div>

  <div id="errorContainer" style="display:none;" class="alert alert-danger">
    <p id="errorMessage"></p>
  </div>
</div>

<!-- Tooltip personalizado -->
<div id="customTooltip"></div>

<style>
/* Estilos generales, formularios, gráficos, etc. */

.container {
  max-width: 1200px; 
  margin: 0 auto;
  padding: 20px;
}

.card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  margin-bottom: 20px;
  max-width: 1000px;
  margin-left: auto;
  margin-right: auto;
  width: 100%;
}

.page-title {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 20px;
}

.page-title i {
  font-size: 24px;
}

.form-row {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}
.form-group {
  flex: 1;
  min-width: 220px;
  margin-bottom: 15px;
}
.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
}
input[type="date"],
select {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
}

/* Estilos para Awesomplete */
.search-container {
  position: relative;
  width: 100%;
}
.search-input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
}
.search-input:focus {
  outline: none;
  border-color: #1a73e8;
  box-shadow: 0 0 0 3px rgba(26,115,232,0.2);
}
div.awesomplete {
  position: relative !important;
  display: block !important;
  width: 100% !important;
}
div.awesomplete > ul {
  position: absolute !important;
  left: 0 !important;
  top: calc(100% + 5px) !important;
  min-width: 100%;
  background: white !important;
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: 6px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.08);
  margin: 0;
  padding: 0;
  list-style: none;
  z-index: 1000;
}
div.awesomplete > ul > li:first-child {
  background-color: #2c3e50 !important;
  color: white !important;
  border-top-left-radius: 6px;
  border-top-right-radius: 6px;
  border-left-color: #2c3e50 !important;
}
div.awesomplete > ul > li:not(:first-child) {
  background-color: white !important;
  color: black !important;
}
div.awesomplete > ul > li:hover:not(:first-child),
div.awesomplete > ul > li[aria-selected="true"]:not(:first-child) {
  background-color: #f8f9fa !important;
  border-left-color: #1a73e8;
}

/* Botones */
.btn-primary {
  background-color: #1a73e8;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 15px;
  transition: background-color 0.2s ease;
}
.btn-primary:hover {
  background-color: #1557b0;
}
.btn-secondary {
  background-color: green;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 15px;
  transition: background-color 0.2s ease;
}
.btn-secondary:hover {
  background-color: blue;
}

/* Gráfico */
.graph-container {
  margin-bottom: 20px;
}
#graphDiv {
  display: block;
  width: 95%;
  margin: 0 auto;
  height: 600px;
  border: 1px solid #eee;
  box-sizing: border-box;
}
.button-container {
  text-align: center;
  margin-top: 20px;
}
#loadingMessage {
  text-align: center;
  padding: 20px;
  font-size: 16px;
  font-weight: 500;
}

/* Alertas */
.alert {
  padding: 15px;
  border-radius: 4px;
  margin-bottom: 20px;
}
.alert-danger {
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  color: #721c24;
}
.alert-warning {
  background-color: #fff3cd;
  border: 1px solid #ffeeba;
  color: #856404;
}

/* Tooltip personalizado */
#customTooltip {
  display: none;
  position: absolute;
  background: white;
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 8px;
  font-size: 12px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  z-index: 1000;
  pointer-events: none;
  min-width: 200px;
}
</style>
{% endblock %}

{% block scripts %}
<!-- Cargamos Awesomplete y Plotly -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/awesomplete@1.1.5/awesomplete.css">
<script src="https://cdn.jsdelivr.net/npm/awesomplete@1.1.5/awesomplete.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  initializeDates();
  setupProductSearch();
  setupForm();
  setupDownloadButton();
  setupBrandChange();
});

/**
 * Inicializa las fechas por defecto (start: hace 30 días, end: hoy)
 */
function initializeDates() {
  const today = new Date();
  const thirtyDaysAgo = new Date(today);
  thirtyDaysAgo.setDate(today.getDate() - 30);
  document.getElementById('end_date').value = today.toISOString().split('T')[0];
  document.getElementById('start_date').value = thirtyDaysAgo.toISOString().split('T')[0];
}

/**
 * Configura Awesomplete para el input de producto.
 * Al seleccionar un producto, actualiza el select de marcas usando el endpoint.
 */
function setupProductSearch() {
  const searchInput = document.getElementById('product_search');
  const hiddenInput = document.getElementById('product_name');
  
  let products = {{ products|tojson|safe }};
  let uniqueProducts = Array.from(new Set(products));
  
  let awesomplete = new Awesomplete(searchInput, {
    minChars: 1,
    maxItems: 10,
    autoFirst: true,
    list: uniqueProducts
  });

  searchInput.addEventListener('awesomplete-selectcomplete', function() {
    hiddenInput.value = searchInput.value;
    // Actualiza marcas para el producto seleccionado
    const productName = searchInput.value;
    fetch(`/get_brands_for_product?product_name=${encodeURIComponent(productName)}`)
      .then(response => response.json())
      .then(data => {
        updateBrandSelect(data.brands);
        // También actualiza presentaciones (usando todas las marcas disponibles inicialmente)
        updatePresentationSelect(data.presentations);
      })
      .catch(error => console.error('Error al obtener marcas:', error));
  });
}

/**
 * Actualiza el select de marcas con la lista recibida y lo habilita para selección múltiple.
 */
function updateBrandSelect(brands) {
  const brandSelect = document.getElementById('brand');
  // Limpia el select y agrega la opción "Todas"
  brandSelect.innerHTML = '<option value="all">Todas</option>';
  brands.forEach(brand => {
    const option = document.createElement('option');
    option.value = brand;
    option.textContent = brand;
    brandSelect.appendChild(option);
  });
}

/**
 * Actualiza el select de presentaciones con la lista recibida.
 */
function updatePresentationSelect(presentations) {
  const presentationSelect = document.getElementById('presentation');
  presentationSelect.innerHTML = '<option value="all">Todas</option>';
  presentations.forEach(pres => {
    const option = document.createElement('option');
    option.value = pres;
    option.textContent = pres;
    presentationSelect.appendChild(option);
  });
}

/**
 * Escucha los cambios en el select de marcas (múltiple) para actualizar presentaciones.
 * Cuando cambian las marcas seleccionadas, se envía una petición para obtener las presentaciones vinculadas.
 */
function setupBrandChange() {
  const brandSelect = document.getElementById('brand');
  brandSelect.addEventListener('change', function() {
    const selectedOptions = Array.from(brandSelect.selectedOptions).map(opt => opt.value);
    const productName = document.getElementById('product_name').value;
    
    // Si se selecciona "all" o no se selecciona nada, usamos todas las presentaciones disponibles
    if (selectedOptions.length === 0 || selectedOptions.includes('all')) {
      // Se puede recargar las presentaciones del endpoint de marcas para el producto
      fetch(`/get_brands_for_product?product_name=${encodeURIComponent(productName)}`)
        .then(response => response.json())
        .then(data => {
          updatePresentationSelect(data.presentations);
        })
        .catch(error => console.error('Error al actualizar presentaciones:', error));
    } else {
      // Si se seleccionan múltiples marcas, se unen con comas
      const brandsParam = selectedOptions.join(',');
      fetch(`/get_presentations?product_name=${encodeURIComponent(productName)}&brands=${encodeURIComponent(brandsParam)}`)
        .then(response => response.json())
        .then(data => {
          updatePresentationSelect(data.presentations);
        })
        .catch(error => console.error('Error al actualizar presentaciones:', error));
    }
  });
}

/**
 * Maneja el envío del formulario para generar el gráfico
 */
function setupForm() {
  const form = document.getElementById('graphForm');
  form.addEventListener('submit', async function(event) {
    event.preventDefault();
    const formData = new FormData(this);
    if (formData.get('start_date') > formData.get('end_date')) {
      showError('La fecha de inicio no puede ser mayor a la fecha de fin.');
      return;
    }
    const loadingMessage = document.getElementById('loadingMessage');
    const graphDiv = document.getElementById('graphDiv');
    try {
      loadingMessage.style.display = 'block';
      graphDiv.style.display = 'none';
      const response = await fetch('/generate_graph', { method: 'POST', body: formData });
      if (response.redirected && response.url.includes('/login')) {
        showError('Debe iniciar sesión para generar gráficos. Redirigiendo...');
        setTimeout(() => { window.location.href = response.url; }, 2000);
        return;
      }
      const data = await response.json();
      if (!response.ok) { throw new Error(data.error || 'Error en la respuesta del servidor'); }
      loadingMessage.style.display = 'none';
      graphDiv.style.display = 'block';
      createPlot(data);
      document.getElementById('downloadButton').style.display = 'block';
    } catch (error) {
      console.error('Error:', error);
      showError(error.message);
      loadingMessage.style.display = 'none';
    }
  });
}

/**
 * Configura el botón de descarga de imagen del gráfico
 */
function setupDownloadButton() {
  document.getElementById('downloadButton').addEventListener('click', function() {
    Plotly.downloadImage('graphDiv', {
      format: 'png',
      filename: 'grafico',
      width: 1200,
      height: 800,
      scale: 2
    });
  });
}

/**
 * Función para crear el gráfico (utiliza Plotly)
 */

function createPlot(data) {
  if (!data.data || !Array.isArray(data.data) || data.data.length === 0) {
    showError('No hay datos para graficar');
    return;
  }

  // Paleta de colores para series normales (excluyendo la línea de regresión)
  const colors = [
    '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
    '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'
  ];

  const traces = [];
  let allPrices = [];

  data.data.forEach((item, index) => {
    const isRegression = (item.line && item.mode === 'lines'); // Verifica si es la línea de regresión

    // Recopilamos los precios para calcular el rango
    allPrices = allPrices.concat(item.prices);

    let traceConfig = {
      x: item.dates,
      y: item.prices,
      name: isRegression ? 'Línea de regresión' : item.label, // Aseguramos un nombre adecuado en la leyenda
      hoverinfo: 'none'
    };

    if (isRegression) {
      traceConfig.mode = item.mode;
      traceConfig.line = item.line;
    } else {
      traceConfig.mode = 'lines+markers';
      traceConfig.marker = {
        size: 8,
        color: colors[index % colors.length],
        line: { color: 'black', width: 1 }
      };
      traceConfig.line = { width: 2 };
    }

    traces.push(traceConfig);
  });

  // Calcular el rango de precios
  const minPrice = Math.min(...allPrices);
  const maxPrice = Math.max(...allPrices);
  const priceRange = maxPrice - minPrice;
  const margin = priceRange * 0.1;
  const yMin = Math.max(0, minPrice - margin);
  const yMax = maxPrice + margin;

  // Configuración del layout con una mejor ubicación de la leyenda
  const layout = {
    title: { text: data.title, font: { size: 24 } },
    xaxis: { 
      title: 'Fecha', 
      tickangle: -45, 
      automargin: true, 
      showline: true, 
      linecolor: 'black', 
      linewidth: 2,
      gridcolor: '#e0e0e0'
    },
    yaxis: {
      title: 'Precio',
      tickformat: priceRange < 0.1 ? '.3f' : '.2f',
      automargin: true,
      showline: true,
      linecolor: 'black',
      linewidth: 2,
      range: [yMin, yMax],
      nticks: priceRange < 0.1 ? 5 : 8,
      gridcolor: '#e0e0e0'
    },
    showlegend: true,
    legend: { 
      x: 0.05, 
      y: 1.15, 
      orientation: 'h', 
      yanchor: 'bottom', 
      xanchor: 'left', 
      bgcolor: 'rgba(255,255,255,0.8)',
      bordercolor: 'black',
      borderwidth: 1
    },
    hovermode: 'closest',
    margin: { l: 100, r: 50, t: 120, b: 150 },
    plot_bgcolor: 'white',
    paper_bgcolor: 'white',
    autosize: true,
    height: 700
  };

  const config = {
    responsive: true,
    displayModeBar: true,
    displaylogo: false,
    modeBarButtonsToRemove: ['lasso2d', 'select2d']
  };

  // Dibujar el gráfico en Plotly
  Plotly.newPlot('graphDiv', traces, layout, config).then(function(gd) {
    console.log("Gráfico generado con éxito");
  });
}



/**
 * Muestra un mensaje de error en la parte superior
 */
function showError(message) {
  const errorContainer = document.getElementById('errorContainer');
  const errorMessage = document.getElementById('errorMessage');
  errorMessage.textContent = message;
  errorContainer.style.display = 'block';
  setTimeout(() => { errorContainer.style.display = 'none'; }, 5000);
}
</script>
{{ super() }}
{% endblock %}

























