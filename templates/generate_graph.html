{% extends "base.html" %}

{% block content %}
<!-- Reemplazar el select original con el nuevo campo de búsqueda -->
<div class="form-group">
  <label for="product_search">Nombre del producto:</label>
  <div class="search-container">
    <input 
      type="text" 
      id="product_search" 
      class="search-input" 
      placeholder="Buscar producto..." 
      autocomplete="off">
    <div id="product_suggestions" class="suggestions-container"></div>
    <input type="hidden" id="product_name" name="product_name" required>
  </div>
</div>

<style>
.search-container {
  position: relative;
  width: 100%;
}

.search-input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 16px;
}

.suggestions-container {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  max-height: 200px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 0 0 4px 4px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  z-index: 1000;
}

.suggestion-item {
  padding: 8px 12px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}

.suggestion-item:last-child {
  border-bottom: none;
}

.suggestion-item:hover {
  background-color: #f5f5f5;
}

.suggestion-item.selected {
  background-color: #e0e0e0;
}

.highlight {
  background-color: #fff3cd;
  padding: 0 2px;
}
</style>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  setupProductSearch();
});

function setupProductSearch() {
  const searchInput = document.getElementById('product_search');
  const suggestionsContainer = document.getElementById('product_suggestions');
  const hiddenInput = document.getElementById('product_name');
  let products = {{ products|tojson|safe }};
  let selectedIndex = -1;
  let filteredProducts = [];

  // Función para resaltar el texto coincidente
  function highlightMatch(text, query) {
    if (!query) return text;
    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
  }

  // Función para mostrar sugerencias
  function showSuggestions(query) {
    query = query.toLowerCase();
    filteredProducts = products.filter(product => 
      product.toLowerCase().includes(query)
    );

    if (filteredProducts.length > 0 && query) {
      suggestionsContainer.innerHTML = filteredProducts
        .map((product, index) => `
          <div class="suggestion-item ${index === selectedIndex ? 'selected' : ''}"
               data-index="${index}">
            ${highlightMatch(product, query)}
          </div>
        `)
        .join('');
      suggestionsContainer.style.display = 'block';
    } else {
      suggestionsContainer.style.display = 'none';
    }
  }

  // Función para seleccionar un producto
  function selectProduct(product) {
    searchInput.value = product;
    hiddenInput.value = product;
    suggestionsContainer.style.display = 'none';
    selectedIndex = -1;
    
    // Disparar el evento change para actualizar los filtros dependientes
    const event = new Event('change');
    hiddenInput.dispatchEvent(event);
  }

  // Event listeners
  searchInput.addEventListener('input', (e) => {
    const query = e.target.value;
    showSuggestions(query);
  });

  searchInput.addEventListener('keydown', (e) => {
    if (!filteredProducts.length) return;

    switch(e.key) {
      case 'ArrowDown':
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, filteredProducts.length - 1);
        showSuggestions(searchInput.value);
        break;
      case 'ArrowUp':
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        showSuggestions(searchInput.value);
        break;
      case 'Enter':
        e.preventDefault();
        if (selectedIndex >= 0) {
          selectProduct(filteredProducts[selectedIndex]);
        }
        break;
      case 'Escape':
        suggestionsContainer.style.display = 'none';
        selectedIndex = -1;
        break;
    }
  });

  suggestionsContainer.addEventListener('click', (e) => {
    const item = e.target.closest('.suggestion-item');
    if (item) {
      const index = parseInt(item.dataset.index);
      selectProduct(filteredProducts[index]);
    }
  });

  // Cerrar sugerencias al hacer clic fuera
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
      suggestionsContainer.style.display = 'none';
    }
  });

  // Mantener la funcionalidad de filtros dependientes
  hiddenInput.addEventListener('change', function() {
    const selectedProduct = this.value;
    fetch(`/get_product_filters?product_name=${encodeURIComponent(selectedProduct)}`)
      .then(response => response.json())
      .then(data => {
        updateFilters(data);
      })
      .catch(error => console.error('Error al obtener filtros:', error));
  });
}

function updateFilters(data) {
  // Actualizar select de marcas
  const brandSelect = document.getElementById('brand');
  brandSelect.innerHTML = '<option value="all">Todas</option>';
  data.brands.forEach(brand => {
    const option = document.createElement('option');
    option.value = brand;
    option.textContent = brand;
    brandSelect.appendChild(option);
  });

  // Actualizar select de presentaciones
  const presentationSelect = document.getElementById('presentation');
  presentationSelect.innerHTML = '<option value="all">Todas</option>';
  data.presentations.forEach(presentation => {
    const option = document.createElement('option');
    option.value = presentation;
    option.textContent = presentation;
    presentationSelect.appendChild(option);
  });
}
</script>
{% endblock %}
