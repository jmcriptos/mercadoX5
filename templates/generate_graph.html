<!DOCTYPE html>
<html>

<head>
    <title>Generar Gráfico</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
    <div class="container">
        <img src="../static/LOGO JOMAR.png" alt="MercadoX5" class="logo" />
    </div>
    <h1>MercadoX5</h1>
    <h1>Generar Gráfico</h1>
    <form id="graphForm" method="POST" action="/graph">
        <div>
            <label for="start_date">Fecha de inicio:</label>
            <input type="date" id="start_date" name="start_date" required>
        </div>

        <div>
            <label for="end_date">Fecha de fin:</label>
            <input type="date" id="end_date" name="end_date" required>
        </div>

        <div>
            <label for="product_name">Nombre del producto:</label>
            <select id="product_name" name="product_name" required>
                {% for product in products %}
                <option value="{{ product.name }}">{{ product.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="brand">Marca:</label>
            <select id="brand" name="brand">
                <option value="all">Todas</option>
                {% for brand in brands %}
                <option value="{{ brand }}">{{ brand }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="store">Tienda:</label>
            <select id="store" name="store">
                <option value="all">Todas</option>
                {% for store in stores %}
                <option value="{{ store.id }}">{{ store.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="presentation">Presentación:</label>
            <select id="presentation" name="presentation" required>
                {% for presentation in presentations %}
                <option value="{{ presentation[0] }}">{{ presentation[0] }}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit">Generar Gráfico</button>
    </form>

    <div id="graphDiv"></div>

    <div class="button-container">
        <a href="/"><button>Volver</button></a>
    </div>

    <script>
document.getElementById('graphForm').addEventListener('submit', function (e) {
    e.preventDefault();

    fetch('/graph', {
        method: 'POST',
        body: new FormData(e.target)
    })
        .then(response => response.json())
        .then(data => {
            // Limpieza de las fechas
            data.data.forEach(item => {
                item.dates = item.dates.map(date => {
                    return date.split(" ")[0]; // Separar la fecha y el tiempo y tomar solo la fecha
                });
            });

            let traces = data.data.map((item, index) => {
                const colors = [
                    '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
                    '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'
                ];
                return {
                    x: item.dates,
                    y: item.prices,
                    mode: 'lines+markers',
                    name: item.label,
                    hovertext: item.prices.map((p) => `Tienda: ${item.label}<br>Precio: ${p}`),
                    hoverinfo: 'text',
                    marker: {
                        size: 10,
                        color: colors[index % colors.length]
                    },
                    line: {
                        color: colors[index % colors.length]
                    },
                    hoverlabel: {
                        bgcolor: 'rgba(0, 0, 0, 0)',  // Fondo transparente
                        font: {
                            color: colors[index % colors.length], // Color del texto basado en la tienda
                            size: 12,
                            lineheight: 1.5
                        },
                        align: 'left',
                        bordercolor: 'rgba(0,0,0,0)',
                        namelength: -1, // No cortar los nombres
                    }
                };
            });

            const layout = {
                title: data.title,
                xaxis: {
                    title: data.xAxisTitle,
                    tickformat: '%Y-%m-%d'
                },
                yaxis: {
                    title: data.yAxisTitle,
                    tickangle: -45,
                    tickfont: {
                        size: 10
                    }
                },
                legend: {
                    font: {
                        size: 10
                    }
                },
                margin: {
                    t: 40,
                    b: 40,
                    l: 60,
                    r: 40
                },
                autosize: true,
                height: 600,
                width: 1000,
                hovermode: 'closest',
                hoverlabel: {
                    align: 'auto',
                    textfont: {
                        size: 12,
                        color: '#ffffff'
                    }
                }
            };

            Plotly.newPlot('graphDiv', traces, layout);
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Hubo un error generando el gráfico.');
        });
});


    </script>
</body>

</html>

