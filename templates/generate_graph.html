{% extends "base.html" %}

{% block head_extra %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/awesomplete@1.1.5/awesomplete.css">
  <script src="https://cdn.jsdelivr.net/npm/awesomplete@1.1.5/awesomplete.min.js"></script>
{% endblock %}

{% block content %}
<div class="container">
  <div class="page-title">
    <i class="fas fa-chart-line"></i>
    <h1>Generar Gr치fico</h1>
  </div>

  {% if not current_user.is_authenticated %}
    <div class="alert alert-warning">
      <i class="fas fa-exclamation-triangle"></i>
      Debe iniciar sesi칩n para generar gr치ficos.
      <a href="{{ url_for('login', next=request.path) }}" class="alert-link">Iniciar sesi칩n</a>
    </div>
  {% endif %}

  <form id="graphForm" class="card" method="POST" action="/generate_graph">
    <div class="form-group">
      <label for="start_date">Fecha de inicio:</label>
      <input type="date" id="start_date" name="start_date" required>
    </div>
    <div class="form-group">
      <label for="end_date">Fecha de fin:</label>
      <input type="date" id="end_date" name="end_date" required>
    </div>

    <!-- Campo de b칰squeda de productos con autocompletado -->
    <div class="form-group">
      <label for="product_search">Nombre del producto:</label>
      <input 
        type="text" 
        id="product_search" 
        class="awesomplete" 
        placeholder="Buscar producto..." 
        autocomplete="off">
      <input type="hidden" id="product_name" name="product_name" required>
    </div>

    <div class="form-group">
      <label for="brand">Marca:</label>
      <select id="brand" name="brand">
        <option value="all">Todas</option>
        {% for b in all_brands %}
          <option value="{{ b }}">{{ b }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label for="store">Tienda:</label>
      <select id="store" name="store">
        <option value="all">Todas</option>
        {% for s in stores %}
          <option value="{{ s.id }}">{{ s.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label for="presentation">Presentaci칩n:</label>
      <select id="presentation" name="presentation" required>
        <option value="all">Todas</option>
        {% for p in all_presentations %}
          <option value="{{ p }}">{{ p }}</option>
        {% endfor %}
      </select>
    </div>
    <button type="submit" class="btn-primary">Generar Gr치fico</button>
  </form>

  <div class="graph-container">
    <div id="loadingMessage" style="display:none;">Cargando gr치fico...</div>
    <div id="graphDiv" style="width: 100%; height: 700px;"></div>
    <button id="downloadButton" class="btn-secondary" style="display:none;">Descargar como imagen</button>
  </div>
</div>

<div id="errorContainer" style="display:none;" class="alert alert-danger">
  <p id="errorMessage"></p>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  setupAwesomplete();
  initializeDates();
  setupForm();
  setupDownloadButton();
});

function setupAwesomplete() {
  const productInput = document.getElementById('product_search');
  const hiddenInput = document.getElementById('product_name');
  
  let awesomplete = new Awesomplete(productInput, {
    minChars: 1,
    maxItems: 10,
    autoFirst: true
  });

  let debounceTimer;
  productInput.addEventListener('input', function() {
    const query = productInput.value.trim();
    clearTimeout(debounceTimer);

    if (!query) {
      awesomplete.list = [];
      return;
    }

    debounceTimer = setTimeout(() => {
      console.log("Buscando productos para:", query); // 游릭 DEBUG
      fetch(`/search_products?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          console.log("Respuesta recibida:", data); // 游릭 DEBUG
          awesomplete.list = data;
        })
        .catch(err => console.error('Error al buscar productos:', err));
    }, 300);
  });

  productInput.addEventListener('awesomplete-selectcomplete', function() {
    hiddenInput.value = productInput.value;
  });
}

function initializeDates() {
  const today = new Date();
  const thirtyDaysAgo = new Date(today);
  thirtyDaysAgo.setDate(today.getDate() - 30);
  document.getElementById('end_date').value = today.toISOString().split('T')[0];
  document.getElementById('start_date').value = thirtyDaysAgo.toISOString().split('T')[0];
}

function setupForm() {
  const form = document.getElementById('graphForm');
  form.addEventListener('submit', async function(event) {
    event.preventDefault();
    const formData = new FormData(this);
    
    if (formData.get('start_date') > formData.get('end_date')) {
      showError('La fecha de inicio no puede ser mayor a la fecha de fin.');
      return;
    }

    const loadingMessage = document.getElementById('loadingMessage');
    const graphDiv = document.getElementById('graphDiv');

    try {
      loadingMessage.style.display = 'block';
      graphDiv.style.display = 'none';

      const response = await fetch('/generate_graph', {
        method: 'POST',
        body: formData
      });

      if (response.redirected && response.url.includes('/login')) {
        showError('Debe iniciar sesi칩n para generar gr치ficos. Redirigiendo...');
        setTimeout(() => { window.location.href = response.url; }, 2000);
        return;
      }

      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.error || 'Error en la respuesta del servidor');
      }

      loadingMessage.style.display = 'none';
      graphDiv.style.display = 'block';
      createPlot(data);
      document.getElementById('downloadButton').style.display = 'block';

    } catch (error) {
      console.error('Error:', error);
      showError(error.message);
      loadingMessage.style.display = 'none';
    }
  });
}

function setupDownloadButton() {
  document.getElementById('downloadButton').addEventListener('click', function() {
    Plotly.downloadImage('graphDiv', {
      format: 'png',
      filename: 'grafico',
      width: 1200,
      height: 800,
      scale: 2
    });
  });
}

function showError(message) {
  const errorContainer = document.getElementById('errorContainer');
  const errorMessage = document.getElementById('errorMessage');
  errorMessage.textContent = message;
  errorContainer.style.display = 'block';
  setTimeout(() => { errorContainer.style.display = 'none'; }, 5000);
}
</script>
{% endblock %}







