<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gráfico de Precios</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .graph-container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    #graphDiv {
      width: 100%;
      height: 600px;
    }
    .button-container {
      text-align: center;
      margin-top: 20px;
    }
    .btn {
      padding: 8px 16px;
      background-color: #ccc;
      text-decoration: none;
      color: #000;
      border-radius: 4px;
    }
    .btn:hover {
      background-color: #aaa;
    }
    #customTooltip {
      position: absolute;
      display: none;
      background: white;
      border: 1px solid #ccc;
      padding: 8px;
      border-radius: 4px;
      z-index: 100;
      pointer-events: none;
      font-size: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    #customTooltip .tooltip-date {
      font-weight: bold;
      margin-bottom: 5px;
      border-bottom: 1px solid #eee;
      padding-bottom: 3px;
    }
    #customTooltip .tooltip-item {
      padding: 2px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>MercadoX5</h1>
    <h2>Gráfico de Precios</h2>

    <div class="graph-container">
      <div id="graphDiv"></div>
    </div>

    <div class="button-container">
      <a href="/" class="btn">Volver</a>
    </div>
  </div>

  <div id="customTooltip"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const jsonData = {{ data|tojson|safe }};
      
      if (!jsonData || !jsonData.data || !Array.isArray(jsonData.data) || jsonData.data.length === 0) {
        console.warn("No hay series de datos para graficar.");
        document.getElementById("graphDiv").innerHTML = "<p>No se encontraron datos para este gráfico.</p>";
        return;
      }
      
      // Ordenar las series según el último precio
      let sortedData = jsonData.data.map(item => {
        const lastPrice = item.prices[item.prices.length - 1];
        return { originalData: item, lastPrice: lastPrice };
      });
      sortedData.sort((a, b) => b.lastPrice - a.lastPrice);
      
      const traces = sortedData.map((itemObj, index) => {
        const item = itemObj.originalData;
        const colors = [
          '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
          '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'
        ];
        
        return {
          x: item.dates,
          y: item.prices,
          mode: 'lines+markers',
          name: item.label,
          hoverinfo: 'none',
          line: {
            color: colors[index % colors.length]
          },
          marker: {
            size: 8,
            color: colors[index % colors.length]
          }
        };
      });
      
      const layout = {
        title: {
          text: jsonData.title || "Gráfico de Precios",
          font: { size: 20 }
        },
        xaxis: {
          title: { text: 'Fecha', standoff: 30 },
          tickangle: -45,
          tickformat: '%b %d, %Y',
          automargin: true
        },
        yaxis: {
          title: 'Precio',
          tickformat: '.2f'
        },
        showlegend: true,
        legend: {
          x: 0,
          y: -0.5,
          orientation: 'h',
          yanchor: 'top'
        },
        hovermode: false,
        margin: {
          l: 80,
          r: 50,
          t: 100,
          b: 200
        }
      };
      
      const config = {
        responsive: true,
        displayModeBar: true,
        displaylogo: false
      };
      
      Plotly.newPlot('graphDiv', traces, layout, config).then(function(gd) {
        const graphDiv = document.getElementById('graphDiv');
        const customTooltip = document.getElementById('customTooltip');
        
        function dateStrToMs(dateStr) {
          return Date.parse(dateStr);
        }
        
        function formatPrice(price) {
          return `Bs. ${price.toFixed(2)}`;
        }
        
        graphDiv.addEventListener('mousemove', function(evt) {
          const bb = graphDiv.getBoundingClientRect();
          const mouseX = evt.clientX - bb.left;
          
          let xRange = gd._fullLayout.xaxis.range;
          let xOffset = gd._fullLayout.xaxis._offset;
          let xLength = gd._fullLayout.xaxis._length;
          
          if (mouseX < xOffset || mouseX > (xOffset + xLength)) {
            customTooltip.style.display = 'none';
            return;
          }
          
          let frac = (mouseX - xOffset) / xLength;
          let xDataMs = xRange[0] + frac * (xRange[1] - xRange[0]);
          
          let pointsAtX = [];
          traces.forEach(function(trace) {
            let bestIdx = null;
            let bestDiff = Infinity;
            
            trace.x.forEach((date, idx) => {
              let tMs = dateStrToMs(date);
              let diff = Math.abs(tMs - xDataMs);
              if (diff < bestDiff) {
                bestDiff = diff;
                bestIdx = idx;
              }
            });
            
            const threshold = 259200000; // 3 días
            if (bestIdx !== null && bestDiff < threshold) {
              pointsAtX.push({
                store: trace.name,
                price: Number(trace.y[bestIdx])
              });
            }
          });
          
          if (pointsAtX.length === 0) {
            customTooltip.style.display = 'none';
            return;
          }
          
          // Ordenar puntos por precio de menor a mayor
          pointsAtX.sort((a, b) => a.price - b.price);
          
          const hoveredDate = new Date(xDataMs).toLocaleDateString('es-VE', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
          
          let tooltipContent = `<div class="tooltip-date">${hoveredDate}</div>`;
          pointsAtX.forEach(pt => {
            tooltipContent += `<div class="tooltip-item">${pt.store}: ${formatPrice(pt.price)}</div>`;
          });
          
          customTooltip.innerHTML = tooltipContent;
          customTooltip.style.display = 'block';
          
          // Posicionar tooltip evitando que se salga de la pantalla
          let tooltipX = evt.clientX + 10;
          let tooltipY = evt.clientY + 10;
          
          const tooltipRect = customTooltip.getBoundingClientRect();
          if (tooltipX + tooltipRect.width > window.innerWidth) {
            tooltipX = evt.clientX - tooltipRect.width - 10;
          }
          if (tooltipY + tooltipRect.height > window.innerHeight) {
            tooltipY = evt.clientY - tooltipRect.height - 10;
          }
          
          customTooltip.style.left = tooltipX + "px";
          customTooltip.style.top = tooltipY + "px";
        });
        
        graphDiv.addEventListener('mouseout', function() {
          customTooltip.style.display = 'none';
        });
      });
      
      window.addEventListener('resize', function() {
        Plotly.Plots.resize('graphDiv');
      });
    });
  </script>
</body>
</html>
