<!DOCTYPE html>
<html>
<head>
    <title>Gráfico</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .graph-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MercadoX5</h1>
        <h1>Gráfico de Precios</h1>
        <div class="graph-container">
            <div id="graphDiv"></div>
        </div>
    </div>

    <script>
        function formatPrice(price) {
            return new Intl.NumberFormat('es-CW', {
                style: 'currency',
                currency: 'ANG',
                minimumFractionDigits: 2
            }).format(price);
        }

        function loadGraph() {
            const urlParams = new URLSearchParams(window.location.search);
            const jsonStr = urlParams.get('data');
            
            if (jsonStr) {
                try {
                    const data = JSON.parse(jsonStr);
                    
                    // Ordenar las series por el último precio registrado
                    data.data.sort((a, b) => {
                        const lastPriceA = a.prices[a.prices.length - 1];
                        const lastPriceB = b.prices[b.prices.length - 1];
                        return lastPriceB - lastPriceA; // Orden descendente
                    });

                    const traces = data.data.map((item) => ({
                        x: item.dates,
                        y: item.prices,
                        mode: 'lines+markers',
                        name: `${item.label} (${formatPrice(item.prices[item.prices.length - 1])})`,
                        hoverinfo: 'text',
                        hovertext: item.prices.map((p, i) => 
                            `${item.label}<br>Fecha: ${item.dates[i]}<br>Precio: ${formatPrice(p)}`
                        ),
                        line: { shape: 'linear' },
                        marker: { size: 8 }
                    }));

                    const layout = {
                        title: {
                            text: data.title,
                            font: { size: 20 },
                            y: 0.95,
                            x: 0.5,
                            xanchor: 'center',
                            yanchor: 'top'
                        },
                        xaxis: {
                            title: 'Mes y Año',
                            tickangle: -45,
                            tickfont: { size: 12 },
                            tickformat: '%b %Y'
                        },
                        yaxis: {
                            title: data.yAxisTitle,
                            tickformat: '.2f',
                            tickprefix: 'ANG ',
                            tickfont: { size: 12 }
                        },
                        height: 600,
                        autosize: true,
                        showlegend: true,
                        legend: {
                            x: 0,
                            y: -0.2,
                            orientation: 'h',
                            yanchor: 'top'
                        },
                        margin: {
                            l: 60,
                            r: 30,
                            t: 80,
                            b: 150
                        },
                        hovermode: 'x unified',
                        hoverdistance: 100,
                        spikedistance: 1000,
                        hoverlabel: {
                            namelength: 100,
                            bgcolor: 'white',
                            bordercolor: 'gray'
                        },
                        xaxis: {
                            showspikes: true,
                            spikecolor: 'black',
                            spikethickness: 1,
                            spikedash: 'dot',
                            spikemode: 'across',
                            spikesnap: 'cursor',
                            title: 'Mes y Año',
                            tickformat: '%b %Y'
                        }
                    };

                    const config = {
                        responsive: true,
                        displayModeBar: true,
                        displaylogo: false,
                        modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                        toImageButtonOptions: {
                            format: 'png',
                            filename: 'grafico_precios',
                            height: 600,
                            width: 1000,
                            scale: 2
                        }
                    };

                    Plotly.newPlot('graphDiv', traces, layout, config);
                    
                    // Hacer el gráfico responsive
                    window.addEventListener('resize', function() {
                        Plotly.Plots.resize('graphDiv');
                    });
                } catch (error) {
                    console.error('Error parsing or plotting data:', error);
                    document.getElementById('graphDiv').innerHTML = 
                        '<p style="color: red;">Error al generar el gráfico</p>';
                }
            }
        }

        // Cargar el gráfico cuando la página esté lista
        document.addEventListener('DOMContentLoaded', loadGraph);
    </script>

    <div class="button-container">
        <a href="/" class="btn">Volver</a>
    </div>
</body>
</html>