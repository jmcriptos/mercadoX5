<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gráfico de Precios</title>
  <!-- Import Plotly -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <!-- Tu CSS principal -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .graph-container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    #graphDiv {
      width: 100%;
      height: 600px;
    }
    .button-container {
      text-align: center;
      margin-top: 20px;
    }
    .btn {
      padding: 8px 16px;
      background-color: #ccc;
      text-decoration: none;
      color: #000;
      border-radius: 4px;
    }
    .btn:hover {
      background-color: #aaa;
    }
    /* Estilos para el tooltip personalizado */
    #customTooltip {
      position: absolute;
      display: none;
      background: #fff;
      border: 1px solid #ccc;
      padding: 5px;
      z-index: 100;
      pointer-events: none;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>MercadoX5</h1>
    <h2>Gráfico de Precios</h2>

    <div class="graph-container">
      <!-- Contenedor donde se dibujará la gráfica -->
      <div id="graphDiv"></div>
    </div>

    <div class="button-container">
      <!-- Botón para volver al home (ajusta la ruta si es necesario) -->
      <a href="/" class="btn">Volver</a>
    </div>
  </div>

  <!-- Contenedor para el tooltip personalizado -->
  <div id="customTooltip"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // "jsonData" se pasa desde Flask como 'data' en render_template
      const jsonData = {{ data|tojson|safe }};
      
      if (!jsonData) {
        console.error("No se recibió 'jsonData' desde el servidor.");
        return;
      }
      
      // Verificamos que existan series de datos
      if (!jsonData.data || !Array.isArray(jsonData.data) || jsonData.data.length === 0) {
        console.warn("No hay series de datos para graficar.");
        document.getElementById("graphDiv").innerHTML = "<p>No se encontraron datos para este gráfico.</p>";
        return;
      }
      
      // Ordenar las series según el último precio (descendente)
      let sortedData = jsonData.data.map(item => {
        const lastPrice = item.prices[item.prices.length - 1];
        return {
          originalData: item,
          lastPrice: lastPrice
        };
      });
      sortedData.sort((a, b) => b.lastPrice - a.lastPrice);
      
      // Construir las trazas de Plotly.
      // Se usa "hoverinfo: 'skip'" para desactivar el tooltip predeterminado.
      // NOTA: Las trazas se crean en el orden definido por "sortedData" (que influye en la leyenda)
      const traces = sortedData.map((element, index) => {
        const item = element.originalData;
        return {
          x: item.dates, // Se asume que las fechas vienen en formato "YYYY-MM-DD"
          y: item.prices,
          mode: 'lines+markers',
          name: item.label,
          hoverinfo: 'skip', // Desactiva el tooltip por defecto
          legendrank: index  // Este valor afecta el orden de la leyenda
        };
      });
      
      // Configuración del layout con eje x sin cortes
      const layout = {
        title: {
          text: jsonData.title || "Gráfico de Precios",
          font: { size: 20 }
        },
        xaxis: {
          title: { text: 'Fecha', standoff: 30 },
          tickangle: -45,
          tickformat: '%b %d, %Y',
          automargin: true
        },
        yaxis: {
          title: 'Precio',
          tickformat: '.2f'
        },
        showlegend: true,
        legend: {
          x: 0,
          y: -0.5,
          orientation: 'h',
          yanchor: 'top'
        },
        // Usamos hovermode 'x unified' para que se capten todos los puntos de la misma fecha
        hovermode: 'x unified',
        margin: {
          l: 80,
          r: 50,
          t: 100,
          b: 200
        }
      };
      
      const config = {
        responsive: true,
        displayModeBar: true,
        displaylogo: false
      };
      
      // Para depuración, se imprime el orden de las series (según la leyenda)
      console.log('Orden de series (según sortedData):');
      sortedData.forEach(el => {
        console.log(`${el.originalData.label}: ${el.lastPrice}`);
      });
      
      // Renderizar el gráfico
      Plotly.newPlot('graphDiv', traces, layout, config).then(function() {
        const graphDiv = document.getElementById('graphDiv');
        const customTooltip = document.getElementById('customTooltip');
        
        // Evento hover: en lugar de usar eventData.points (que están en orden de leyenda),
        // recorremos manualmente cada traza para extraer el valor (precio) para la fecha hoverada.
        graphDiv.on('plotly_hover', function(eventData) {
          // Obtenemos la fecha hoverada a partir del primer punto (la misma en todas las trazas)
          const hoveredX = eventData.points[0].x;
          // Construir un array para almacenar { name, y } para cada traza donde exista esa fecha.
          let pointsAtX = [];
          // Recorrer cada traza del arreglo "traces" (global en este script)
          traces.forEach(function(trace) {
            // Buscar el índice en el que la fecha de la traza coincide con hoveredX
            for (let i = 0; i < trace.x.length; i++) {
              // Comparamos como cadenas (se asume formato "YYYY-MM-DD")
              if (trace.x[i].toString() === hoveredX.toString()) {
                pointsAtX.push({
                  name: trace.name,
                  y: Number(trace.y[i])
                });
                break; // Se encontró la fecha en esta traza, salimos del bucle
              }
            }
          });
          
          // Depuración: imprimir el array obtenido antes de ordenar
          console.log("Puntos antes de ordenar:", pointsAtX);
          
          // Ordenar el array pointsAtX de menor a mayor por el valor y (precio)
          pointsAtX.sort((a, b) => a.y - b.y);
          
          // Depuración: imprimir el array ordenado
          console.log("Puntos ordenados por precio:", pointsAtX);
          
          // Construir el contenido del tooltip a partir del array ordenado
          let tooltipContent = "<b>" + hoveredX + "</b><br>";
          pointsAtX.forEach(function(pt) {
            tooltipContent += pt.name + ": " + pt.y.toFixed(2) + "<br>";
          });
          customTooltip.innerHTML = tooltipContent;
          
          // Posicionar el tooltip cerca del cursor
          customTooltip.style.display = "block";
          customTooltip.style.left = (eventData.event.clientX + 10) + "px";
          customTooltip.style.top = (eventData.event.clientY + 10) + "px";
        });
        
        // Ocultar el tooltip cuando se retira el cursor
        graphDiv.on('plotly_unhover', function() {
          customTooltip.style.display = "none";
        });
      });
      
      // Ajustar la gráfica si la ventana cambia de tamaño
      window.addEventListener('resize', function() {
        Plotly.Plots.resize('graphDiv');
      });
    });
  </script>
</body>
</html>