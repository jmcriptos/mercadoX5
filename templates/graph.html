<!DOCTYPE html>
<html>
<head>
    <title>Gráfico</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>MercadoX5</h1>
        <h1>Gráfico de Precios</h1>
        <div id="graphDiv"></div>
    </div>

    <script>
        function formatPrice(price) {
            return new Intl.NumberFormat('es-VE', {
                style: 'currency',
                currency: 'USD'
            }).format(price);
        }

        function loadGraph() {
            const urlParams = new URLSearchParams(window.location.search);
            const jsonStr = urlParams.get('data');
            
            if (jsonStr) {
                try {
                    const data = JSON.parse(jsonStr);
                    const traces = data.data.map((item) => ({
                        x: item.dates,
                        y: item.prices,
                        mode: 'lines+markers',
                        name: item.label,
                        hoverinfo: 'text',
                        hovertext: item.prices.map((p, i) => 
                            `${item.label}<br>Fecha: ${item.dates[i]}<br>Precio: ${formatPrice(p)}`
                        ),
                        line: { shape: 'linear' },
                        marker: { size: 8 }
                    }));

                    const layout = {
                        title: {
                            text: data.title,
                            font: { size: 24 }
                        },
                        xaxis: {
                            title: data.xAxisTitle,
                            tickangle: -45,
                            tickfont: { size: 12 }
                        },
                        yaxis: {
                            title: data.yAxisTitle,
                            tickformat: '$.2f',
                            tickfont: { size: 12 }
                        },
                        height: 600,
                        width: 1000,
                        showlegend: true,
                        legend: {
                            x: 1,
                            xanchor: 'right',
                            y: 1
                        },
                        margin: {
                            l: 50,
                            r: 50,
                            t: 50,
                            b: 100
                        },
                        hovermode: 'closest'
                    };

                    const config = {
                        responsive: true,
                        displayModeBar: true,
                        displaylogo: false,
                        modeBarButtonsToRemove: ['lasso2d', 'select2d']
                    };

                    Plotly.newPlot('graphDiv', traces, layout, config);
                } catch (error) {
                    console.error('Error parsing or plotting data:', error);
                    document.getElementById('graphDiv').innerHTML = 
                        '<p style="color: red;">Error al generar el gráfico</p>';
                }
            }
        }

        // Cargar el gráfico cuando la página esté lista
        document.addEventListener('DOMContentLoaded', loadGraph);
    </script>

    <div class="button-container">
        <a href="/" class="btn">Volver</a>
    </div>
</body>
</html>