<!DOCTYPE html>
<html>
<head>
    <title>Gráfico</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .graph-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        #graphDiv {
            width: 100%;
            min-height: 600px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MercadoX5</h1>
        <h1>Gráfico de Precios</h1>
        <div class="graph-container">
            <div id="graphDiv"></div>
        </div>
        <div class="button-container">
            <a href="/" class="btn">Volver</a>
        </div>
    </div>

    <script>
        function formatPrice(price) {
            return new Intl.NumberFormat('es-CW', {
                style: 'currency',
                currency: 'ANG',
                minimumFractionDigits: 2
            }).format(price);
        }

        function loadGraph() {
            const urlParams = new URLSearchParams(window.location.search);
            const formData = new FormData(document.getElementById('graphForm'));
            
            fetch('/graph', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Ordenar las series por el último precio registrado
                data.data.sort((a, b) => {
                    const lastPriceA = a.prices[a.prices.length - 1];
                    const lastPriceB = b.prices[b.prices.length - 1];
                    return lastPriceB - lastPriceA;
                });

                const traces = data.data.map(item => ({
                    x: item.dates,
                    y: item.prices,
                    mode: 'lines+markers',
                    name: `${item.label} (${formatPrice(item.prices[item.prices.length - 1])})`,
                    hoverinfo: 'text',
                    hovertext: item.prices.map((p, i) => 
                        `${item.label}<br>Fecha: ${item.dates[i]}<br>Precio: ${formatPrice(p)}`
                    ),
                    line: { shape: 'linear' },
                    marker: { size: 8 }
                }));

                const layout = {
                    title: {
                        text: data.title,
                        font: { size: 20 },
                        x: 0.5,
                        xanchor: 'center'
                    },
                    xaxis: {
                        title: 'Mes y Año',
                        tickangle: -45,
                        tickformat: '%b %Y',
                        showspikes: true,
                        spikecolor: 'black',
                        spikethickness: 1,
                        spikedash: 'dot',
                        spikemode: 'across'
                    },
                    yaxis: {
                        title: 'Precio',
                        tickprefix: 'ANG ',
                        tickformat: '.2f'
                    },
                    showlegend: true,
                    legend: {
                        x: 0,
                        y: -0.5,
                        orientation: 'h',
                        yanchor: 'top'
                    },
                    margin: {
                        l: 80,
                        r: 50,
                        t: 100,
                        b: 200
                    },
                    hovermode: 'x unified',
                    hoverdistance: 100
                };

                const config = {
                    responsive: true,
                    displayModeBar: true,
                    displaylogo: false
                };

                Plotly.newPlot('graphDiv', traces, layout, config);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('graphDiv').innerHTML = 
                    '<p style="color: red;">Error al generar el gráfico</p>';
            });
        }

        // Cargar el gráfico cuando la página esté lista
        document.addEventListener('DOMContentLoaded', loadGraph);

        // Hacer el gráfico responsive
        window.addEventListener('resize', () => {
            Plotly.Plots.resize('graphDiv');
        });
    </script>
</body>
</html>